<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>脈問堂</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/firebase-app-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<style>
:root {
--earth-beige: #f9f6f1;
--clay-brown: #8a7663;
--stone-gray: #82827a;
--moss-green: #5f6e55;
--charcoal: #383833;
--shadow: #2a2a25;
--text-primary: #333330;
--text-secondary: #686863;
--paper: #fdfcf8;
--border-radius: 16px;
--box-shadow: 0 8px 30px rgba(0, 0, 0, 0.07);
--transition: all 0.35s cubic-bezier(0.23, 1, 0.32, 1);
--transition-fast: all 0.2s cubic-bezier(0.23, 1, 0.32, 1);
--primary-gradient: linear-gradient(135deg, var(--clay-brown), var(--charcoal));
--secondary-gradient: linear-gradient(135deg, var(--moss-green), #535f4c);
}

* {
  transition: var(--transition-fast);
}

body {
  font-family: 'Noto Serif TC', serif;
  background: var(--earth-beige);
  color: var(--text-primary);
  min-height: 100vh;
  background-attachment: fixed;
  line-height: 1.6;
  position: relative;
}

body::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: none;
  z-index: -2;
}

.wabi-sabi-card {
  background: var(--paper);
  border: 1px solid rgba(141, 123, 104, 0.15);
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.wabi-sabi-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--moss-green), var(--clay-brown));
  opacity: 0.85;
}

.wabi-sabi-button {
  background: var(--earth-beige);
  color: var(--charcoal);
  border: 1px solid rgba(141, 123, 104, 0.3);
  border-radius: var(--border-radius);
  padding: 13px 26px;
  font-family: 'Noto Serif TC', serif
  font-weight: 600;
  letter-spacing: 0.5px;
  transition: var(--transition);
  cursor: pointer;
  position: relative;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.wabi-sabi-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.2);
  transform: translateY(100%);
  transition: transform 0.3s ease;
  z-index: 0;
}

.wabi-sabi-button:hover::before {
  transform: translateY(0);
}

.wabi-sabi-button span {
  position: relative;
  z-index: 1;
}

.wabi-sabi-button:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.wabi-sabi-button:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.wabi-sabi-button.primary {
  background: var(--primary-gradient);
  color: white;
  border: none;
  box-shadow: 0 4px 12px rgba(138, 118, 99, 0.3);
}

.wabi-sabi-button.primary:hover {
  box-shadow: 0 6px 18px rgba(138, 118, 99, 0.4);
}

.wabi-sabi-button.primary:active {
  transform: translateY(1px);
  box-shadow: 0 2px 8px rgba(138, 118, 99, 0.35);
}

.wabi-sabi-button.danger {
  background: linear-gradient(135deg, #a86b6b, #8b5555);
  color: white;
  border: none;
  box-shadow: 0 4px 12px rgba(168, 107, 107, 0.3);
}

.wabi-sabi-button.danger:hover {
  box-shadow: 0 6px 18px rgba(168, 107, 107, 0.4);
}

.input-field {
  background-color: var(--earth-beige);
  border: 1px solid rgba(126, 126, 118, 0.3);
  color: var(--text-primary);
  border-radius: 14px;
  padding: 14px 18px;
  font-family: 'Noto Serif TC', serif;
  font-weight: 500;
  transition: var(--transition);
  box-shadow: 0 2px 4px rgba(0,0,0,0.03);
}

#studentAnswer {
  min-height: 300px; 
  overflow: hidden; 
  resize: none; 
  white-space: pre-wrap; 
  word-wrap: break-word; 
}

  #studentAnswer.no-modal-editor {
    overflow-y: auto; /* 允許垂直滾動 */
    max-height: 300px; /* 設置最大高度，超過會顯示滾動條 */
    resize: vertical; /* 允許手動調整大小 */
}

/* 確保textarea在聚焦時有正確的外觀 */
#studentAnswer.no-modal-editor:focus {
    outline: none;
    border-color: var(--clay-brown);
    box-shadow: 0 0 0 3px rgba(138, 118, 99, 0.2);
    background-color: var(--earth-beige);
}

.input-field:focus {
  outline: none;
  border-color: var(--clay-brown);
  box-shadow: 0 0 0 3px rgba(138, 118, 99, 0.2);
  background-color: var(--earth-beige);
}

.input-field::placeholder {
  color: var(--text-secondary);
  opacity: 0.7;
  font-weight: 400;
}

/* Modal Styles from Sansi */
.outline-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.65);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    padding: 1rem;
    box-sizing: border-box;
    backdrop-filter: blur(5px);
}

.outline-modal-content {
    background-color: #fdfdfd;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 5px 25px rgba(0,0,0,0.2);
    width: 90%;
    max-width: 800px;
    height: 80vh;
    position: relative;
    animation: fadeInScale 0.3s;
    display: flex;
    flex-direction: column;
}

.outline-modal-content h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: var(--charcoal);
    font-size: 1.5em;
    font-weight: 700;
    border-bottom: 1px solid rgba(138, 118, 99, 0.2);
    padding-bottom: 10px;
}

#modal-textarea {
    width: 100%;
    box-sizing: border-box;
    font-size: 1.3em;
    line-height: 1.6;
    border: 1px solid rgba(138, 118, 99, 0.3);
    border-radius: 8px;
    padding: 15px;
    flex-grow: 1;
    resize: none;
    background-color: #faf9f6;
    color: #333;
    font-family: 'Noto Serif TC', serif;
}

#modal-textarea:focus {
    outline: none;
    border-color: var(--clay-brown);
    box-shadow: 0 0 0 3px rgba(138, 118, 99, 0.1);
}

.outline-modal-content .modal-buttons {
    display: flex;
    justify-content: flex-end;
    margin-top: 15px;
    gap: 10px;
}

.outline-modal-content .preview-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--stone-gray);
    transition: color 0.2s;
}

.outline-modal-content .preview-close-btn:hover {
    color: var(--charcoal);
}

/* Hover effect for inputs to indicate they are clickable */
textarea:not(.no-modal-editor), input[type="text"]:not(.no-modal-editor) {
    cursor: pointer;
    transition: background-color 0.2s;
}

textarea:not(.no-modal-editor):hover, input[type="text"]:not(.no-modal-editor):hover {
    background-color: rgba(138, 118, 99, 0.05);
}
/* End Modal Styles */

.qr-section {
  background: var(--earth-beige);
  border: 2px solid rgba(126, 126, 118, 0.25);
  border-radius: var(--border-radius);
  padding: 28px;
  text-align: center;
  box-shadow: inset 0 0 15px rgba(0,0,0,0.03);
  transition: var(--transition);
}

.qr-section:hover {
  box-shadow: 0 0 20px rgba(0,0,0,0.05), inset 0 0 15px rgba(0,0,0,0.05);
}

.countdown-display {
  font-family: 'Noto Serif TC', serif;
  font-size: 4.2rem;
  font-weight: 700;
  color: var(--charcoal);
  text-shadow: 0 2px 4px rgba(0,0,0,0.08);
  letter-spacing: -1.5px;
  position: relative;
  line-height: 1;
}

.countdown-display::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 80%;
  height: 3px;
  background: var(--primary-gradient);
  border-radius: 3px;
  opacity: 0.8;
}

.student-card {
  transition: var(--transition);
  border-left-width: 4px;
  background-color: var(--earth-beige);
  position: relative;
  overflow: hidden;
  box-shadow: 0 3px 10px rgba(0,0,0,0.04);
  cursor: pointer;
}

.student-card.answered {
  border-left-color: var(--moss-green);
}

.student-card.late {
  border-left-color: #a86b6b;
}

.student-card:hover {
  transform: translateX(5px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.08);
}

.question-display {
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  background: var(--earth-beige);
  border-radius: var(--border-radius);
  border: 1px dashed rgba(141, 123, 104, 0.4);
  margin-bottom: 24px;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
  font-family: 'Noto Serif TC', serif;
  font-weight: 500;
  font-size: 1.25rem;
  line-height: 1.5;
}

.question-display span {
  position: relative;
  z-index: 1;
}

.copy-success {
  background: rgba(95, 110, 85, 0.15);
  border-color: var(--moss-green);
  color: var(--moss-green);
  box-shadow: 0 0 12px rgba(95, 110, 85, 0.2);
}

.answer-input-area {
  transition: var(--transition);
  position: relative;
}

.answer-input-area.submitted {
  transform: scale(0.98);
  opacity: 0.95;
  box-shadow: 0 0 15px rgba(95, 110, 85, 0.2);
}

.answer-input-area.late {
  border-left: 4px solid #a86b6b;
  box-shadow: 0 0 15px rgba(168, 107, 107, 0.2);
}

.text-wabi {
  color: var(--clay-brown);
  font-family: 'Noto Serif TC', serif;
  font-weight: 600;
}

.text-wabi-secondary {
  color: var(--text-secondary);
  font-family: 'Noto Serif TC', serif;
  font-weight: 400;
}

.icon-shadow {
  text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.12);
  transition: var(--transition-fast);
}

.fade-in {
  animation: fadeIn 0.6s ease-out forwards;
}

@keyframes fadeIn {
  from { 
    opacity: 0; 
    transform: translateY(10px);
  }
  to { 
    opacity: 1; 
    transform: translateY(0);
  }
}

.time-input-group {
  display: flex;
  align-items: center;
  gap: 16px;
  background: var(--earth-beige);
  border: 1px solid rgba(141, 123, 104, 0.3);
  border-radius: var(--border-radius);
  padding: 14px 18px;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
}

.time-input {
  width: 75px;
  background: transparent;
  border: none;
  text-align: center;
  font-family: 'Noto Serif TC', serif;
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--charcoal);
  padding: 6px 0;
  position: relative;
  z-index: 1;
}

.time-input:focus {
  outline: none;
  box-shadow: none;
}

.time-input::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 2px;
  background: var(--clay-brown);
  transition: width 0.3s ease;
  z-index: 0;
}

.time-input:focus::after {
  width: 80%;
}

.time-unit {
  color: var(--stone-gray);
  font-weight: 600;
  font-size: 1.2rem;
  font-family: 'Noto Serif TC', serif;
  letter-spacing: 0.5px;
}

.room-code {
  font-family: 'Noto Serif TC', serif;
  font-size: 1.65rem;
  color: var(--clay-brown);
  letter-spacing: 2px;
  font-weight: 700;
  text-shadow: 0 1px 2px rgba(0,0,0,0.05);
  position: relative;
  display: inline-block;
}

.room-code::after {
  content: '';
  position: absolute;
  bottom: -4px;
  left: 0;
  width: 100%;
  height: 2px;
  background: var(--moss-green);
  opacity: 0.7;
}

.copyright-footer {
  position: fixed;
  bottom: 12px;
  right: 12px;
  padding: 6px 15px;
  background: var(--earth-beige);
  color: var(--charcoal);
  border-radius: 12px 0 0 0;
  border: 1px solid rgba(141, 123, 104, 0.25);
  font-family: 'Noto Serif TC', serif;
  font-size: 0.8rem;
  z-index: 100;
  box-shadow: -2px -2px 8px rgba(0,0,0,0.05);
  transition: var(--transition);
}

.copyright-footer:hover {
  transform: translateX(-3px);
  box-shadow: -3px -3px 12px rgba(0,0,0,0.08);
}

.host-countdown-container {
  text-align: center;
  padding: 20px;
  background: rgba(138, 118, 99, 0.04);
  border-radius: var(--border-radius);
  margin-top: 24px;
  min-height: 90px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid rgba(141, 123, 104, 0.2);
  position: relative;
  overflow: hidden;
}

.host-countdown {
  font-family: 'Noto Serif TC', serif;
  font-size: 3.6rem;
  font-weight: 700;
  color: var(--charcoal);
  text-shadow: 0 2px 4px rgba(0,0,0,0.08);
  letter-spacing: -1px;
  position: relative;
  z-index: 1;
  line-height: 1;
}

.time-control-container {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-bottom: 8px;
}

@media (min-width: 768px) {
  .time-control-container {
    flex-direction: row;
    align-items: flex-end;
  }
  .time-input-wrapper {
    flex: 1;
  }
}

.time-button-wrapper {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 8px;
  position: relative;
  z-index: 10;
}

.question-title {
  font-family: 'Noto Serif TC', serif;
  font-size: 1.45rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.time-title {
  font-family: 'Noto Serif TC', serif;
  font-size: 1.15rem;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

#participantsStatus {
  scrollbar-width: thin;
  scrollbar-color: var(--stone-gray) transparent;
}

#participantsStatus::-webkit-scrollbar {
  width: 6px;
}

#participantsStatus::-webkit-scrollbar-track {
  background: transparent;
}

#participantsStatus::-webkit-scrollbar-thumb {
  background-color: var(--stone-gray);
  border-radius: 3px;
}

#answersList {
  scrollbar-width: thin;
  scrollbar-color: var(--stone-gray) transparent;
}

#answersList::-webkit-scrollbar {
  width: 6px;
}

#answersList::-webkit-scrollbar-track {
  background: transparent;
}

#answersList::-webkit-scrollbar-thumb {
  background-color: var(--stone-gray);
  border-radius: 3px;
}

.card-header {
  display: flex;
  align-items: center;
  gap: 10px;
}

.card-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: rgba(138, 118, 99, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--clay-brown);
}

#submitBtn {
  position: relative;
  overflow: hidden;
}

#submitBtn::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.6s;
}

#submitBtn:hover::after {
  left: 100%;
}

.section-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  margin-bottom: 2rem;
}

.section-title {
  font-family: 'Noto Serif TC', serif;
  font-size: 2.2rem;
  font-weight: 700;
  color: var(--charcoal);
  margin-bottom: 0.5rem;
}

.section-subtitle {
  color: var(--text-secondary);
  font-family: 'Noto Serif TC', serif;
  font-size: 1.1rem;
}

.role-button {
  transition: var(--transition);
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;
}

.role-button::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(45deg, var(--clay-brown), var(--moss-green));
  z-index: 0;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.role-button:hover::before {
  opacity: 1;
}

.role-button span {
  position: relative;
  z-index: 2;
}

.role-icon {
  font-size: 2.8rem;
  margin-bottom: 1rem;
  transition: var(--transition);
}

.role-button:hover .role-icon {
  transform: scale(1.1);
}

.role-title {
  font-family: ''Noto Serif TC', serif;
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.role-desc {
  font-family: 'Noto Serif TC', serif;
  color: var(--text-secondary);
}

.role-button.primary {
  background: rgba(138, 118, 99, 0.1); 
  border: 1px solid rgba(138, 118, 99, 0.3);
}

.role-button.primary:hover {
  background: rgba(138, 118, 99, 0.15); 
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(138, 118, 99, 0.25);
}

.role-button.primary .role-icon {
  color: var(--clay-brown); 
}

.role-button.primary .role-title,
.role-button.primary .role-desc {
  color: var(--charcoal); 
}

@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.9; }
  100% { transform: scale(1); opacity: 1; }
}

.pulse {
  animation: pulse 2s infinite;
}

.wabi-sabi-button:hover .icon-shadow {
  transform: scale(1.1);
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

@keyframes fadeInScale {
  from { 
    opacity: 0; 
    transform: scale(0.95);
  }
  to { 
    opacity: 1; 
    transform: scale(1);
  }
}

.fade-in-scale {
  animation: fadeInScale 0.5s ease-out forwards;
}

.floating {
  animation: float 3s ease-in-out infinite;
}

@media (max-width: 768px) {
  .countdown-display {
    font-size: 3.2rem;
  }
  .host-countdown {
    font-size: 2.8rem;
  }
  .section-title {
    font-size: 1.8rem;
  }
  .role-button {
    padding: 1.5rem;
  }
  .role-icon {
    font-size: 2.2rem;
  }
  .time-input {
    width: 60px;
    font-size: 1.1rem;
  }
}

@media (max-width: 480px) {
  .countdown-display {
    font-size: 2.8rem;
  }
  .host-countdown {
    font-size: 2.4rem;
  }
  .section-title {
    font-size: 1.6rem;
  }
  .role-button {
    padding: 1.2rem;
  }
  .role-icon {
    font-size: 1.8rem;
  }
  .time-input-group {
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }
  .time-input {
    width: 80px;
  }
}

.answer-display {
  cursor: text;
  padding-top: 8px;
  padding-right: 8px; 
  padding-bottom: 8px;
  padding-left: 8px;  
  border: 1px solid transparent;
  border-radius: 10px;
  transition: var(--transition);
  min-height: 60px;
  background: var(--paper);
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-wrap: break-word;
  outline: none;
  font-size: 1.3rem; 
  line-height: 1.8; 
}

.answer-display:hover {
  background-color: rgba(138, 118, 99, 0.05);
  border: 1px dashed rgba(138, 118, 99, 0.3);
}

.answer-display:focus {
  background-color: var(--earth-beige);
  border: 1px solid var(--clay-brown);
  box-shadow: 0 0 0 2px rgba(138, 118, 99, 0.2);
}

.editing-indicator {
  position: absolute;
  top: 10px;
  right: 10px;
  background: var(--moss-green);
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  font-weight: 500;
  opacity: 0;
  transition: opacity 0.3s;
}

.student-card.editing .editing-indicator {
  opacity: 1;
}

#fullscreenAnswers {
  transition: opacity 0.3s ease;
  background: var(--paper);
}

#fullscreenAnswers:not(.hidden) {
  display: flex !important;
}

.fullscreen-answer-card {
  background: var(--paper);
  border: 1px solid rgba(141, 123, 104, 0.15);
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
  margin-bottom: 1.5rem;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
  cursor: pointer;
}

.fullscreen-answer-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--moss-green), var(--clay-brown));
  opacity: 0.85;
}

.fullscreen-answer-card.editing {
  border: 2px solid var(--clay-brown);
  box-shadow: 0 0 20px rgba(138, 118, 99, 0.2);
}

.fullscreen-toggle-btn {
  position: static; 
  margin-left: auto; 
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--earth-beige);
  border: 1px solid rgba(141, 123, 104, 0.3);
  color: var(--clay-brown);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  flex-shrink: 0; 
}

.fullscreen-toggle-btn:hover {
  transform: scale(1.1);
  background: rgba(138, 118, 99, 0.1);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  color: var(--charcoal);
}

.answers-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1rem;
  position: relative;
}

.answers-title-wrapper {
  display: flex;
  align-items: center;
  gap: 15px; 
  flex: 1; 
}

#fullscreenToggle {
  margin-left: 30px; 
  order: 2; 
}

.font-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-left: auto; 
  order: 1; 
}

#answersList {
  position: relative;
}

#fullscreenAnswers .student-card {
  margin-bottom: 2rem;
  padding: 1.5rem;
  font-size: 1.1rem;
}

#fullscreenAnswers .answer-display {
  font-size: 1.2rem;
  line-height: 1.8;
  min-height: 150px;
  padding: 1rem;
}

#fullscreenAnswers .answer-display:hover {
  background-color: rgba(138, 118, 99, 0.05);
  border: 1px dashed rgba(138, 118, 99, 0.3);
}

#fullscreenAnswers .answer-display:focus {
  background-color: var(--earth-beige);
  border: 1px solid var(--clay-brown);
  box-shadow: 0 0 0 3px rgba(138, 118, 99, 0.2);
}

.font-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-left: 15px;
}

.font-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--earth-beige);
  border: 1px solid rgba(141, 123, 104, 0.3);
  color: var(--clay-brown);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.9rem;
  font-weight: bold;
}

.font-btn:hover {
  background: rgba(138, 118, 99, 0.1);
  transform: scale(1.05);
}

.font-btn:active {
  transform: scale(0.95);
}

#fullscreenAnswers .font-controls {
  margin-left: auto;
  margin-right: 15px;
}

#fullscreenAnswers .font-btn {
  width: 44px;
  height: 44px;
  font-size: 1.1rem;
}

/* Outline Mode CSS */
.mode-selector, .outline-options {
  margin-bottom: 15px;
}

.outline-options label, .mode-selector label {
  margin-right: 15px;
  cursor: pointer;
  font-weight: 500;
  color: var(--charcoal);
}

.outline-options input[type="radio"], .mode-selector input[type="radio"] {
  margin-right: 5px;
}

.outline-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 1rem;
}

.outline-table th, .outline-table td {
  border: 1px solid rgba(141, 123, 104, 0.3);
  padding: 10px;
  text-align: left;
  vertical-align: top;
}

.outline-table th {
  background: rgba(138, 118, 99, 0.1);
  font-weight: 600;
  color: var(--charcoal);
}

.outline-table textarea {
  width: 100%;
  background: rgba(255,255,255,0.5);
  border: 1px solid rgba(0,0,0,0.1);
  border-radius: 6px;
  padding: 8px;
  resize: vertical;
  min-height: 70px;
  font-family: 'Noto Serif TC', serif;
  font-size: 1rem;
}

.outline-table textarea:focus {
  outline: none;
  border-color: var(--clay-brown);
  background: white;
  box-shadow: 0 0 0 2px rgba(138, 118, 99, 0.1);
}

.outline-control-btn {
  background: var(--earth-beige);
  border: 1px solid var(--clay-brown);
  color: var(--clay-brown);
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  margin-right: 10px;
  transition: all 0.2s;
  font-size: 1rem;
}

.outline-control-btn:hover {
  background: var(--clay-brown);
  color: white;
}

/* Style for rendering table in answer card */
.rendered-outline-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 5px;
  font-size: 0.9em;
}

.rendered-outline-table th, .rendered-outline-table td {
  border: 1px solid rgba(138, 118, 99, 0.3);
  padding: 6px;
  vertical-align: top;
}

.rendered-outline-table th {
  background-color: rgba(138, 118, 99, 0.1);
  font-weight: bold;
}

#studentInputContainer {
  width: 100%;
}

.student-config-area {
  margin-bottom: 15px;
  padding: 10px;
  background: rgba(138, 118, 99, 0.05);
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.config-select {
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid rgba(141, 123, 104, 0.3);
  background: var(--earth-beige);
  font-family: 'Noto Serif TC', serif;
  color: var(--charcoal);
}



</style>
</head>
<body>
<div class="container mx-auto px-4 py-10 max-w-6xl">
<!-- 主選單 -->
<div id="mainMenu" class="space-y-10">
<header class="section-header fade-in-scale">
<h1 class="section-title">
<i class="fas fa-brush text-clay-brown mr-3 icon-shadow"></i>
脈問堂
</h1>
<p class="section-subtitle">簡潔高效的課堂問答計時工具</p>
</header>
<div class="wabi-sabi-card p-8 fade-in" style="animation-delay: 0.2s">
<h2 class="text-2xl font-bold mb-8 text-center text-wabi">
<i class="fas fa-user-cog mr-3"></i>
選擇您的角色
</h2>
<div class="grid md:grid-cols-2 gap-8">
<button onclick="showHostSection()" class="role-button primary wabi-sabi-button p-7 rounded-xl text-center group">
<div class="transform transition-transform duration-300">
<i class="fas fa-user-tie role-icon text-moss-green"></i>
<div class="role-title">主持人</div>
<div class="role-desc">設置問題與計時</div>
</div>
</button>
<button onclick="showJoinSection()" class="role-button secondary wabi-sabi-button p-7 rounded-xl text-center group">
<div class="transform transition-transform duration-300">
<i class="fas fa-user-graduate role-icon text-moss-green"></i>
<div class="role-title">學生</div>
<div class="role-desc">加入問答</div>
</div>
</button>
</div>
</div>
</div>
<!-- 主持人介面 -->
<div id="hostSection" class="hidden space-y-8">
<header class="section-header fade-in-scale">
<h1 class="section-title">
<i class="fas fa-user-tie text-clay-brown mr-3"></i>
主持人介面
</h1>
<p class="section-subtitle">房間代碼: <span id="hostRoomCode" class="room-code"></span></p>
</header>
<div class="grid lg:grid-cols-2 gap-9">
<!-- 左側：QR Code & 控制 -->
<div class="space-y-9">
<div class="wabi-sabi-card p-7 fade-in">
<div class="card-header mb-5">
<div class="card-icon">
<i class="fas fa-qrcode"></i>
</div>
<h2 class="text-xl font-bold text-wabi">分享房間</h2>
</div>
<div class="qr-section">
<div class="mb-5">
<h3 class="text-xl font-bold text-wabi mb-2">掃描加入問答</h3>
<p class="text-wabi-secondary text-sm mb-4">學生可使用手機掃描此二維碼加入</p>
</div>
<div class="flex justify-center mb-5">
<canvas id="qrCanvas" class="bg-earth-beige p-5 rounded-xl border border-stone-gray shadow-md"></canvas>
</div>
<div class="space-y-4">
<button onclick="downloadQR()" class="wabi-sabi-button w-full py-3.5 rounded-xl font-medium">
<i class="fas fa-download mr-2"></i>保存二維碼
</button>
<button onclick="copyShareLink()" id="copyLinkBtn" class="wabi-sabi-button w-full py-3.5 rounded-xl font-medium">
<i class="fas fa-copy mr-2"></i>複製分享連結
</button>
</div>
</div>
</div>
<div class="wabi-sabi-card p-7 fade-in" style="animation-delay: 0.1s">
<div class="card-header mb-5">
<div class="card-icon">
<i class="fas fa-edit"></i>
</div>
<h2 class="text-xl font-bold text-wabi">問題設置</h2>
</div>
<div class="space-y-5">
<!-- 模式選擇 -->
<div class="mode-selector">
  <label><input type="radio" name="questionMode" value="qa" checked onclick="toggleMode()"> 問答模式</label>
  <label><input type="radio" name="questionMode" value="outline" onclick="toggleMode()"> 大綱模式</label>
</div>

<!-- 大綱選項 (隱藏/顯示) -->
<div id="outlineConfig" class="outline-options hidden p-4 bg-earth-beige rounded-lg border border-gray-200">
  <div class="mb-3">
    <span class="font-bold text-gray-700 mr-3">大綱類型:</span>
    <label><input type="radio" name="outlineType" value="narrative" checked> 敘事抒情</label>
    <label><input type="radio" name="outlineType" value="argument"> 議論</label>
  </div>
</div>

<div>
<label class="block text-base font-medium text-wabi-secondary mb-2.5">問題內容</label>
<textarea id="questionInput" class="input-field w-full px-4.5 py-3.5 rounded-xl min-h-[110px] resize-y" placeholder="請在此輸入問題..."></textarea>
</div>
<div class="time-control-container">
<div class="time-input-wrapper">
<div class="time-title">計時設定</div>
<div class="time-input-group">
<input type="number" id="minutesInput" class="input-field time-input px-3 py-2.5" value="10" min="0">
<span class="time-unit">分</span>
<input type="number" id="secondsInput" class="input-field time-input px-3 py-2.5" value="0" min="0" max="59">
<span class="time-unit">秒</span>
</div>
</div>
<div class="time-button-wrapper">
<button id="startBtn" onclick="startSession()" class="wabi-sabi-button primary px-7 py-3.5 rounded-xl font-medium text-lg">
<i class="fas fa-play mr-2"></i>開始
</button>
</div>
</div>
<div class="host-countdown-container hidden" id="hostCountdownContainer">
<div class="host-countdown" id="hostCountdownDisplay">10:00</div>
</div>
</div>
</div>
</div>
<!-- 右側:學生回答列表 -->
<div class="space-y-9">
<div class="wabi-sabi-card p-7 fade-in">
<div class="card-header mb-5">
<div class="card-icon">
<i class="fas fa-users"></i>
</div>
<h2 class="text-xl font-bold text-wabi">參與學生
<span class="text-base font-normal text-wabi-secondary ml-2">(已加入: <span id="participantCount">0</span> 人)</span>
</h2>
</div>
<div id="participantsStatus" class="space-y-3 max-h-64 overflow-y-auto pr-2">
<!-- 學生狀態將在此顯示 -->
<div class="text-center py-10 text-wabi-secondary">尚未有人加入</div>
</div>
</div>
<div class="wabi-sabi-card p-7 fade-in" style="animation-delay: 0.1s">
  <div class="card-header mb-5">
    <div class="card-icon">
      <i class="fas fa-comments"></i>
    </div>
    <div class="answers-header">
  <div class="answers-title-wrapper">
    <h2 class="text-xl font-bold text-wabi">回答列表</h2>
    <div class="font-controls">
      <button class="font-btn decrease-font" title="縮小字體">
        <i class="fas fa-font"></i>
      </button>
      <button class="font-btn increase-font" title="放大字體">
        <i class="fas fa-font"></i><i class="fas fa-plus" style="font-size: 0.6em; margin-left: -2px;"></i>
      </button>
    </div>
  </div>
  <button id="fullscreenToggle" class="fullscreen-toggle-btn" title="全屏檢視回答">
    <i class="fas fa-expand-arrows-alt"></i>
  </button>
</div>
  </div>
<div id="answersList" class="space-y-5 max-h-[620px] overflow-y-auto pr-2">
<!-- 學生回答將在此顯示 -->
<div class="text-center py-12 text-wabi-secondary">尚未開始</div>
</div>
<div class="mt-8 flex justify-end space-x-5 pt-5 border-t border-stone-gray border-opacity-30">
<button onclick="clearSession()" class="wabi-sabi-button danger px-7 py-3.5 rounded-xl font-medium">
<i class="fas fa-broom mr-2"></i>清空
</button>
<button onclick="endSession()" class="wabi-sabi-button primary px-7 py-3.5 rounded-xl font-medium">
<i class="fas fa-stop mr-2"></i>結束
</button>
</div>
</div>
</div>
</div>
<div class="text-center fade-in" style="animation-delay: 0.2s">
<button onclick="leaveHost()" class="wabi-sabi-button px-9 py-3.5 rounded-xl font-medium text-lg">
<i class="fas fa-door-open mr-2"></i>離開房間
</button>
</div>
</div>
<!-- 學生加入介面 -->
<div id="joinSection" class="hidden space-y-10">
<header class="section-header fade-in-scale">
<h1 class="section-title">
<i class="fas fa-user-graduate text-moss-green mr-3"></i>
加入房間
</h1>
<p class="section-subtitle">請輸入您的姓名與房間代碼</p>
</header>
<div class="max-w-md mx-auto fade-in">
<div class="wabi-sabi-card p-9">
<div class="space-y-7">
<div>
<label class="block text-base font-medium text-wabi-secondary mb-3">您的姓名</label>
<input type="text" id="studentName" class="input-field w-full px-5 py-3.5 rounded-xl" placeholder="請輸入您的姓名">
</div>
<div>
<label class="block text-base font-medium text-wabi-secondary mb-3">房間代碼</label>
<input type="text" id="joinRoomCode" class="input-field w-full px-5 py-3.5 rounded-xl text-center text-2xl tracking-wider font-mono" placeholder="000000" maxlength="6">
</div>
<div class="flex gap-5">
<button onclick="joinAsStudent()" class="wabi-sabi-button primary flex-1 py-4 rounded-xl font-medium text-lg">
<i class="fas fa-door-open mr-2"></i>進入
</button>
<button onclick="showMainMenu()" class="wabi-sabi-button px-6 py-4 rounded-xl">
<i class="fas fa-arrow-left"></i>
</button>
</div>
</div>
</div>
</div>
</div>
<!-- 學生答題介面 -->
<div id="studentSection" class="hidden space-y-10">
<header class="section-header fade-in-scale">
<h1 class="section-title">
<i class="fas fa-user-graduate text-moss-green mr-3"></i>
學生作答
</h1>
<p class="section-subtitle">房間: <span id="studentRoomCode" class="room-code"></span> | 姓名: <span id="studentDisplayName"></span></p>
</header>
<div class="wabi-sabi-card p-9 text-center fade-in">
<div class="question-display mb-8">
<p id="questionDisplay" class="text-xl font-medium text-wabi-secondary">請等待主持人開始計時</p>
</div>
<div class="countdown-display mb-10" id="studentCountdown">10:00</div>
<div id="answerInputArea" class="answer-input-area mb-9">
  <div id="studentInputContainer">
    <!-- 這裡將動態生成：文字框 或 大綱表格 -->
    <textarea id="studentAnswer" class="input-field w-full px-5 py-4 rounded-xl min-h-[160px] text-lg resize-y" placeholder="請在此輸入您的回答..." disabled></textarea>
  </div>
</div>
<div class="flex justify-center">
<button id="submitBtn" onclick="submitAnswer()" class="wabi-sabi-button primary px-9 py-4.5 rounded-xl font-medium text-lg hidden" disabled>
<i class="fas fa-paper-plane mr-2"></i>提交
</button>
</div>
<div id="submissionStatus" class="mt-7 text-lg font-medium text-wabi-secondary hidden">
<i class="fas fa-check-circle text-moss-green mr-2"></i>已提交回答
</div>
</div>
<div class="text-center fade-in">
<button onclick="leaveStudent()" class="wabi-sabi-button px-9 py-3.5 rounded-xl font-medium text-lg">
<i class="fas fa-door-open mr-2"></i>離開房間
</button>
</div>
</div>
</div>

<!-- Modal Structure for Text Editing -->
<div id="outline-editor-modal" class="outline-modal-overlay">
  <div class="outline-modal-content">
    <button id="modal-close-btn" class="preview-close-btn" title="關閉">&times;</button>
    <h3 id="modal-title">編輯內容</h3>
    <textarea id="modal-textarea" rows="15" placeholder="請在此輸入..."></textarea>
    <div class="modal-buttons">
      <button id="modal-save-btn" class="wabi-sabi-button primary">確認</button>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
apiKey: "AIzaSyB17JKsoCf-H66g13EphV9H7GfR3MreFOo",
authDomain: "collect-358e3.firebaseapp.com",
databaseURL: "https://collect-358e3-default-rtdb.firebaseio.com",
projectId: "collect-358e3",
storageBucket: "collect-358e3.firebasestorage.app",
messagingSenderId: "1024060422420",
appId: "1:1024060422420:web:52dd61dff75c7abc44aa01"
};

if (!firebase.apps.length) {
firebase.initializeApp(firebaseConfig);
}
const database = firebase.database();

const answerColors = [
  { border: '#8a7663', bg: 'rgba(138, 118, 99, 0.08)' }, 
  { border: '#5f6e55', bg: 'rgba(95, 110, 85, 0.08)' }, 
  { border: '#a86b6b', bg: 'rgba(168, 107, 107, 0.08)' }, 
  { border: '#7b8a8a', bg: 'rgba(123, 138, 138, 0.08)' }, 
  { border: '#8a7b65', bg: 'rgba(138, 123, 101, 0.08)' }, 
  { border: '#658a7b', bg: 'rgba(101, 138, 123, 0.08)' }, 
  { border: '#8a658a', bg: 'rgba(138, 101, 138, 0.08)' }, 
  { border: '#8a8a65', bg: 'rgba(138, 138, 101, 0.08)' }  
];

let currentRoom = null;
let currentUser = null;
let isHost = false;
let timer = null;
let timeLimit = 600; // 10 minutes default
let remainingTime = 0;
let roomRef = null;
let sessionActive = false;
let lastQuestionStartTime = null;
let hasSubmitted = false;
let currentQuestionId = null; 

// Student local state for outline configuration
let studentNarrativeStructure = 'fourPart';
let studentArgSegments = 3;

function showMainMenu() {
document.getElementById('mainMenu').classList.remove('hidden');
document.getElementById('hostSection').classList.add('hidden');
document.getElementById('joinSection').classList.add('hidden');
document.getElementById('studentSection').classList.add('hidden');
if (roomRef) {
roomRef.off();
roomRef = null;
}
clearInterval(timer);
timer = null;
document.getElementById('hostCountdownContainer').classList.add('hidden');
}

function showHostSection() {
document.getElementById('mainMenu').classList.add('hidden');
document.getElementById('hostSection').classList.remove('hidden');
document.getElementById('joinSection').classList.add('hidden');
document.getElementById('studentSection').classList.add('hidden');
createRoom();
}

function showJoinSection() {
document.getElementById('mainMenu').classList.add('hidden');
document.getElementById('hostSection').classList.add('hidden');
document.getElementById('joinSection').classList.remove('hidden');
document.getElementById('studentSection').classList.add('hidden');
const urlParams = new URLSearchParams(window.location.search);
const roomCode = urlParams.get('room');
if (roomCode) {
document.getElementById('joinRoomCode').value = roomCode;
}
}

function showStudentSection() {
document.getElementById('mainMenu').classList.add('hidden');
document.getElementById('hostSection').classList.add('hidden');
document.getElementById('joinSection').classList.add('hidden');
document.getElementById('studentSection').classList.remove('hidden');
hasSubmitted = false;
document.getElementById('submissionStatus').classList.add('hidden');
document.getElementById('answerInputArea').classList.remove('submitted', 'late');
}

function generateRoomCode() {
return Math.floor(100000 + Math.random() * 900000).toString();
}

function generateQRCode(roomCode) {
const canvas = document.getElementById('qrCanvas');
const shareUrl = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
QRCode.toCanvas(canvas, shareUrl, {
width: 200,
height: 200,
margin: 2,
color: {
dark: "#383833",
light: "#fdfcf8"
}
}, function (error) {
if (error) {
console.error('QR CODE生成失敗:', error);
alert('QR CODE生成失敗');
}
});
}

function copyShareLink() {
const shareUrl = `${window.location.origin}${window.location.pathname}?room=${currentRoom}`;
const copyBtn = document.getElementById('copyLinkBtn');
navigator.clipboard.writeText(shareUrl).then(() => {
copyBtn.classList.add('copy-success');
copyBtn.innerHTML = '<i class="fas fa-check mr-2"></i>已複製!';
setTimeout(() => {
copyBtn.classList.remove('copy-success');
copyBtn.innerHTML = '<i class="fas fa-copy mr-2"></i>複製分享連結';
}, 3000);
}).catch(err => {
console.error('複製失敗:', err);
prompt('請手動複製以下連結:', shareUrl);
});
}

function downloadQR() {
const canvas = document.getElementById('qrCanvas');
const link = document.createElement('a');
link.download = `wabi-sabi-room-${currentRoom}-qr.png`;
link.href = canvas.toDataURL();
link.click();
}

async function createRoom() {
try {
const roomCode = generateRoomCode();
const hostName = "主持人";
const roomData = {
code: roomCode,
host: hostName,
created: firebase.database.ServerValue.TIMESTAMP,
participants: {},
session: {
active: false,
question: "",
questionId: Date.now(), 
timeLimit: 600,
startTime: null,
endTime: null
},
answers: {}
};
await database.ref('class_rooms/' + roomCode).set(roomData);
currentRoom = roomCode;
currentUser = hostName;
isHost = true;
currentQuestionId = roomData.session.questionId;
document.getElementById('hostRoomCode').textContent = roomCode;
generateQRCode(roomCode);
setupRoomListener();
} catch (error) {
console.error('創建房間失敗:', error);
alert('創建房間失敗,請重試');
}
}

async function joinAsStudent() {
const studentName = document.getElementById('studentName').value.trim();
const roomCode = document.getElementById('joinRoomCode').value.trim();
if (!studentName || !roomCode) {
alert('請輸入姓名和房間代碼');
return;
}
if (roomCode.length !== 6) {
alert('房間代碼必須是6位數');
return;
}
try {
const roomSnapshot = await database.ref('class_rooms/' + roomCode).once('value');
if (!roomSnapshot.exists()) {
alert('房間不存在');
return;
}
const roomData = roomSnapshot.val();
if (roomData.participants && roomData.participants[studentName]) {
alert('此名稱已被使用,請選擇其他名稱');
return;
}
await database.ref('class_rooms/' + roomCode + '/participants/' + studentName).set({
name: studentName,
joined: firebase.database.ServerValue.TIMESTAMP,
submitted: false,
late: false,
lastQuestionId: roomData.session.questionId || null
});
currentRoom = roomCode;
currentUser = studentName;
isHost = false;
document.getElementById('studentRoomCode').textContent = roomCode;
document.getElementById('studentDisplayName').textContent = studentName;
setupRoomListener();
showStudentSection();
} catch (error) {
console.error('加入房間失敗:', error);
alert('加入房間失敗,請重試');
}
}

function setupRoomListener() {
  if (roomRef) {
    roomRef.off();
  }
  roomRef = database.ref('class_rooms/' + currentRoom);
  
  let updateTimeout = null;
  let lastUpdateTime = 0;
  const MIN_UPDATE_INTERVAL = 300; 
  
  roomRef.on('value', (snapshot) => {
    if (!snapshot.exists()) {
      alert('房間已不存在');
      showMainMenu();
      return;
    }
    
    const roomData = snapshot.val();
    const currentTime = Date.now();
    
    const isCriticalUpdate = 
      roomData.session?.active !== sessionActive ||
      !roomData.session?.active; 
    
    if (isCriticalUpdate || (currentTime - lastUpdateTime) > MIN_UPDATE_INTERVAL) {
      clearTimeout(updateTimeout);
      performUIUpdate(roomData);
      lastUpdateTime = currentTime;
    } else {
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(() => {
        performUIUpdate(roomData);
        lastUpdateTime = Date.now();
      }, 50); 
    }
  });
}

function performUIUpdate(roomData) {
  updateParticipantCount(roomData.participants);
  if (isHost) {
    updateHostUI(roomData);
  } else {
    updateStudentUI(roomData);
  }
}

let currentFontSize = 1.3; 

function initializeFontControls() {
  document.querySelectorAll('.increase-font').forEach(btn => {
    btn.addEventListener('click', increaseFontSize);
  });
  document.querySelectorAll('.decrease-font').forEach(btn => {
    btn.addEventListener('click', decreaseFontSize);
  });
  applyFontSize();
}

function increaseFontSize() {
  currentFontSize = Math.min(3.0, currentFontSize + 0.3); 
  applyFontSize();
}

function decreaseFontSize() {
  currentFontSize = Math.max(1.1, currentFontSize - 0.3); 
  applyFontSize();
}

function applyFontSize() {
  document.querySelectorAll('.answer-display').forEach(element => {
    element.style.fontSize = `${currentFontSize}rem`;
    element.style.lineHeight = '1.8'; 
  });
  document.querySelectorAll('#fullscreenAnswers .answer-display').forEach(element => {
    element.style.fontSize = `${currentFontSize * 1.2}rem`;
    element.style.lineHeight = '1.8';
  });
  localStorage.setItem('answerFontSize', currentFontSize);
}

document.addEventListener('DOMContentLoaded', () => {
  const savedFontSize = localStorage.getItem('answerFontSize');
  if (savedFontSize) {
    currentFontSize = parseFloat(savedFontSize);
  }
  initializeFontControls();
  setTimeout(applyFontSize, 100);
});

function updateParticipantCount(participants) {
  const countElement = document.getElementById('participantCount');
  if (!countElement) return;
  
  const newCount = participants ? Object.values(participants).length : 0;
  const currentCount = parseInt(countElement.textContent) || 0;
  
  if (newCount !== currentCount) {
    countElement.textContent = newCount;
    updateParticipantsStatus(participants);
  }
}

function updateParticipantsStatus(participants) {
  const statusElement = document.getElementById('participantsStatus');
  if (!statusElement) return;
  
  const currentHTML = statusElement.innerHTML;
  const shouldUpdate = shouldUpdateParticipants(participants, currentHTML);
  
  if (!shouldUpdate) return;
  
  if (!participants || Object.keys(participants).length === 0) {
    statusElement.innerHTML = '<div class="text-center py-10 text-wabi-secondary">尚未有人加入</div>';
    return;
  }
  
  const participantArray = Object.values(participants);
  participantArray.sort((a, b) => (a.joined || 0) - (b.joined || 0));
  
  let newHTML = '';
  participantArray.forEach(participant => {
    const statusText = participant.submitted ?
      (participant.late ? '<span class="text-red-600 font-medium">已提交(超時)</span>' : 
                          '<span class="text-moss-green font-medium">已提交</span>') :
      '<span class="text-stone-gray font-medium">未提交</span>';
    
    newHTML += `
      <div class="flex items-center justify-between p-3.5 rounded-xl bg-earth-beige bg-opacity-40 hover:shadow-md transition-shadow">
        <div class="flex items-center">
          <i class="fas fa-user text-clay-brown mr-3 text-lg"></i>
          <span class="font-medium text-base">${participant.name}</span>
        </div>
        <div class="font-medium">${statusText}</div>
      </div>
    `;
  });
  
  statusElement.innerHTML = newHTML;
}

function shouldUpdateParticipants(participants, currentHTML) {
  if (!participants || Object.keys(participants).length === 0) {
    return currentHTML.includes('尚未有人加入');
  }
  const participantCount = Object.keys(participants).length;
  const currentItemCount = (currentHTML.match(/flex items-center justify-between/g) || []).length;
  return participantCount !== currentItemCount;
}

// Host UI Toggle Logic
function toggleMode() {
  const mode = document.querySelector('input[name="questionMode"]:checked').value;
  const outlineConfig = document.getElementById('outlineConfig');
  if (mode === 'outline') {
    outlineConfig.classList.remove('hidden');
  } else {
    outlineConfig.classList.add('hidden');
  }
}

// Student Configuration Logic
function renderStudentOutlineUI(type) {
  const container = document.getElementById('studentInputContainer');
  container.innerHTML = '';
  
  const configDiv = document.createElement('div');
  configDiv.className = 'student-config-area';
  
  if (type === 'narrative') {
    const label = document.createElement('span');
    label.innerText = '選擇結構: ';
    label.className = 'font-bold text-charcoal';
    
    const select = document.createElement('select');
    select.className = 'config-select';
    select.innerHTML = `
      <option value="fourPart" ${studentNarrativeStructure === 'fourPart' ? 'selected' : ''}>起承轉合</option>
      <option value="threeLine" ${studentNarrativeStructure === 'threeLine' ? 'selected' : ''}>三線</option>
    `;
    select.onchange = (e) => {
      studentNarrativeStructure = e.target.value;
      renderNarrativeTable();
    };
    
    configDiv.appendChild(label);
    configDiv.appendChild(select);
    container.appendChild(configDiv);
    renderNarrativeTable();
    
  } else { // argument
    const label = document.createElement('span');
    label.innerText = '結構段數量: ';
    label.className = 'font-bold text-charcoal';
    
    const minusBtn = document.createElement('button');
    minusBtn.className = 'outline-control-btn';
    minusBtn.innerHTML = '<i class="fas fa-minus"></i>';
    minusBtn.onclick = () => { changeStudentArgSegments(-1); };
    
    const countSpan = document.createElement('span');
    countSpan.id = 'studentArgCount';
    countSpan.className = 'font-bold text-lg w-6 text-center';
    countSpan.innerText = studentArgSegments;
    
    const plusBtn = document.createElement('button');
    plusBtn.className = 'outline-control-btn';
    plusBtn.innerHTML = '<i class="fas fa-plus"></i>';
    plusBtn.onclick = () => { changeStudentArgSegments(1); };
    
    configDiv.appendChild(label);
    configDiv.appendChild(minusBtn);
    configDiv.appendChild(countSpan);
    configDiv.appendChild(plusBtn);
    container.appendChild(configDiv);
    renderArgumentTable();
  }
}

function changeStudentArgSegments(delta) {
  studentArgSegments += delta;
  if (studentArgSegments < 1) studentArgSegments = 1;
  if (studentArgSegments > 10) studentArgSegments = 10;
  document.getElementById('studentArgCount').innerText = studentArgSegments;
  renderArgumentTable();
}

function renderNarrativeTable() {
  const container = document.getElementById('studentInputContainer');
  // Remove existing table if any
  const existingTable = container.querySelector('table');
  if (existingTable) existingTable.remove();
  
  const table = document.createElement('table');
  table.className = 'outline-table';
  
  const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th>部份</th><th>結構段重點</th><th>情節大要</th><th>物象</th></tr>';
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  const rows = studentNarrativeStructure === 'fourPart' ? ['起', '承', '轉', '合'] : ['起', '一線', '二線', '三線', '合'];
  
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r}</td><td><textarea placeholder="..."></textarea></td><td><textarea placeholder="..."></textarea></td><td><textarea placeholder="..."></textarea></td>`;
    tbody.appendChild(tr);
  });
  
  table.appendChild(tbody);
  container.appendChild(table);
}

function renderArgumentTable() {
  const container = document.getElementById('studentInputContainer');
  const existingTable = container.querySelector('table');
  if (existingTable) existingTable.remove();
  
  const table = document.createElement('table');
  table.className = 'outline-table';
  
  const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th>部份</th><th>論點</th><th>論據及論證</th></tr>';
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  const rows = ['起'];
  for(let i=1; i<=studentArgSegments; i++) rows.push(`結構段${i}`);
  rows.push('合');
  
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r}</td><td><textarea placeholder="..."></textarea></td><td><textarea placeholder="..."></textarea></td>`;
    tbody.appendChild(tr);
  });
  
  table.appendChild(tbody);
  container.appendChild(table);
}

function updateStudentUI(roomData) {
  const questionDisplay = document.getElementById('questionDisplay');
  const countdownDisplay = document.getElementById('studentCountdown');
  const submitBtn = document.getElementById('submitBtn');
  const submissionStatus = document.getElementById('submissionStatus');
  const answerInputArea = document.getElementById('answerInputArea');
  const container = document.getElementById('studentInputContainer');

  const participant = roomData.participants?.[currentUser] || {};
  
  // Determine current mode and question ID from session data
  const currentMode = roomData.session.mode || 'qa';
  const currentQID = roomData.session.questionId;
  
  // Check what is currently rendered
  const renderedMode = container.getAttribute('data-mode');
  const renderedQID = container.getAttribute('data-qid');

  // If UI needs update (Mode changed OR Question changed OR First load)
  if (currentMode !== renderedMode || currentQID != renderedQID) {
    // Clear and Rebuild
    container.innerHTML = '';
    container.setAttribute('data-mode', currentMode);
    container.setAttribute('data-qid', currentQID);
    
    // Reset local submission states because the UI changed/Question changed
    hasSubmitted = false;
    submissionStatus.classList.add('hidden');
    answerInputArea.classList.remove('submitted', 'late');

   if (currentMode === 'qa') {
    const textarea = document.createElement('textarea');
    textarea.id = 'studentAnswer';
    textarea.className = 'input-field w-full px-5 py-4 rounded-xl min-h-[160px] text-lg no-modal-editor'; // 添加 no-modal-editor 類
    textarea.placeholder = '請在此輸入您的回答...';
    container.appendChild(textarea);
} else if (currentMode === 'outline') {
        const type = roomData.session.outlineConfig?.type || 'narrative';
        renderStudentOutlineUI(type);
    }
  }

  if (roomData.session.active) {
    questionDisplay.textContent = roomData.session.question || '請輸入您的回答';
    questionDisplay.classList.remove('text-wabi-secondary');
    questionDisplay.classList.add('text-charcoal');

    if (roomData.session.startTime && !timer) {
      startLocalTimer(roomData.session.startTime, roomData.session.timeLimit);
    }

    // Enable inputs
    const inputs = container.querySelectorAll('textarea, select, button');
    inputs.forEach(el => el.disabled = false);

    if (participant.submitted && currentQID == renderedQID) {
      hasSubmitted = true;
      submissionStatus.classList.remove('hidden');
      inputs.forEach(el => el.disabled = true);
      submitBtn.classList.add('hidden');
      answerInputArea.classList.add('submitted');
      if (participant.late) {
        answerInputArea.classList.add('late');
      }
    } else if (remainingTime > 0 && !hasSubmitted) {
      submitBtn.classList.remove('hidden');
      submitBtn.disabled = false;
    } else if (!hasSubmitted) {
      inputs.forEach(el => {
        el.disabled = true;
        if(el.tagName === 'TEXTAREA') el.placeholder = '時間已到,無法提交';
      });
      submitBtn.classList.add('hidden');
      submitBtn.disabled = true;
    }
  } else {
    questionDisplay.textContent = '請等待主持人開始計時';
    questionDisplay.classList.add('text-wabi-secondary');
    questionDisplay.classList.remove('text-charcoal');
    countdownDisplay.textContent = '10:00';
    const inputs = container.querySelectorAll('textarea, select, button');
    inputs.forEach(el => {
        el.disabled = true;
        if(el.tagName === 'TEXTAREA') el.placeholder = '請等待主持人開始計時';
    });
    submitBtn.classList.add('hidden');
    submitBtn.disabled = true;
    clearInterval(timer);
    timer = null;
  }
}

function startLocalTimer(startTime, totalTime) {
  clearInterval(timer);
  lastQuestionStartTime = startTime;
  remainingTime = totalTime;
  
  timer = setInterval(() => {
    const currentTime = Date.now();
    const elapsed = Math.floor((currentTime - startTime) / 1000);
    remainingTime = Math.max(0, totalTime - elapsed);
    updateCountdownDisplay(remainingTime);
    
    if (remainingTime <= 0) {
      clearInterval(timer);
      timer = null;
      if (!isHost && !hasSubmitted) {
        const submitBtn = document.getElementById('submitBtn');
        const inputs = document.querySelectorAll('textarea');
        if (submitBtn) {
          submitBtn.classList.add('hidden');
          submitBtn.disabled = true;
        }
        inputs.forEach(el => {
            el.disabled = true;
            el.placeholder = '時間已到,無法提交';
        });
      }
    }
  }, 1000);
  updateCountdownDisplay(remainingTime);
}

function updateCountdownDisplay(seconds) {
  const minutes = Math.floor(seconds / 60);
  const secs = seconds % 60;
  const formattedTime = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

  const studentCountdown = document.getElementById('studentCountdown');
  if (studentCountdown) {
    studentCountdown.textContent = formattedTime;
    if (seconds <= 5) {
      studentCountdown.style.color = '#a86b6b';
      studentCountdown.classList.add('pulse');
    } else if (seconds <= 10) {
      studentCountdown.style.color = '#8a7663';
      studentCountdown.classList.remove('pulse');
    } else {
      studentCountdown.style.color = '#383833';
      studentCountdown.classList.remove('pulse');
    }
  }

  const hostCountdownDisplay = document.getElementById('hostCountdownDisplay');
  if (hostCountdownDisplay) {
    hostCountdownDisplay.textContent = formattedTime;
    if (seconds <= 5) {
      hostCountdownDisplay.style.color = '#a86b6b';
      hostCountdownDisplay.classList.add('pulse');
    } else if (seconds <= 10) {
      hostCountdownDisplay.style.color = '#8a7663';
      hostCountdownDisplay.classList.remove('pulse');
    } else {
      hostCountdownDisplay.style.color = '#383833';
      hostCountdownDisplay.classList.remove('pulse');
    }
  }
}

function updateHostUI(roomData) {
  if (roomData.session.active && roomData.session.startTime) {
    if (!timer) {
      startLocalTimer(roomData.session.startTime, roomData.session.timeLimit);
    }
    document.getElementById('hostCountdownContainer').classList.remove('hidden');
    document.getElementById('startBtn').innerHTML = '<i class="fas fa-pause mr-2"></i>暫停';
  } else {
    clearInterval(timer);
    timer = null;
    remainingTime = timeLimit;
    updateCountdownDisplay(remainingTime);
    document.getElementById('startBtn').innerHTML = '<i class="fas fa-play mr-2"></i>開始';
    document.getElementById('hostCountdownContainer').classList.add('hidden');
  }
  updateAnswersList(roomData.answers, roomData.participants);
}

function getStudentColor(studentName) {
  let hash = 0;
  for (let i = 0; i < studentName.length; i++) {
    hash = studentName.charCodeAt(i) + ((hash << 5) - hash);
  }
  const index = Math.abs(hash) % answerColors.length;
  return answerColors[index];
}

function setupDoubleClickEditing(cardElement, studentName) {
  const answerElement = cardElement.querySelector('.answer-display');
  const saveStatus = cardElement.querySelector('.save-status');
  
  let originalText = answerElement.innerHTML; 
  let saveTimeout = null;
  let isEditing = false;
  
  function startEditing() {
    isEditing = true;
    cardElement.classList.add('editing');
    originalText = answerElement.innerHTML;
    answerElement.contentEditable = "true";
    answerElement.focus();
  }
  
  function endEditing() {
    isEditing = false;
    cardElement.classList.remove('editing');
    answerElement.contentEditable = "false";
    autoSave();
  }
  
  function autoSave() {
    if (!isEditing) return;
    const currentText = answerElement.innerHTML; 
    if (currentText === originalText) return;
    
    if (saveTimeout) clearTimeout(saveTimeout);
    
    saveTimeout = setTimeout(async () => {
      try {
        await database.ref(`class_rooms/${currentRoom}/answers/${studentName}`).update({
          text: currentText 
        });
        saveStatus.classList.remove('hidden');
        setTimeout(() => {
          saveStatus.classList.add('hidden');
        }, 2000);
        originalText = currentText;
      } catch (error) {
        console.error('自動保存失敗:', error);
      }
    }, 1000); 
  }
  
  answerElement.addEventListener('dblclick', () => {
    if (isHost && !isEditing) {
      startEditing();
    }
  });
  
  answerElement.addEventListener('blur', () => {
    if (isEditing) {
      endEditing();
    }
  });
  
  answerElement.addEventListener('input', autoSave);
  
  answerElement.addEventListener('keydown', (e) => {
    if (e.key === 's' && e.ctrlKey) {
      e.preventDefault();
      autoSave();
      saveStatus.innerHTML = '<i class="fas fa-save mr-1"></i>已手動保存';
      saveStatus.classList.remove('hidden');
      setTimeout(() => {
        saveStatus.classList.add('hidden');
      }, 2000);
    } else if (e.key === 'Escape') {
      answerElement.innerHTML = originalText;
      endEditing();
    }
  });
  
  answerElement.title = '雙擊編輯答案，自動保存。按 Ctrl+S 手動保存，按 Escape 取消。';
}

function setupFullscreenAnswers() {
  const fullscreenContainer = document.getElementById('fullscreenAnswers');
  const closeBtn = document.getElementById('closeFullscreen');
  
  closeBtn.addEventListener('click', closeFullscreenAnswers);
  
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !fullscreenContainer.classList.contains('hidden')) {
      closeFullscreenAnswers();
    }
  });
}

function openFullscreenAnswers(answers, participants) {
  const fullscreenContainer = document.getElementById('fullscreenAnswers');
  const answersList = document.getElementById('fullscreenAnswersList');
  
  document.getElementById('hostSection').classList.add('hidden');
  
  if (!answers || Object.keys(answers).length === 0) {
    answersList.innerHTML = '<div class="text-center py-20 text-wabi-secondary text-xl">尚未有回答</div>';
  } else {
    answersList.innerHTML = generateFullscreenAnswersHTML(answers, participants);
    setupFullscreenEditing(answers, participants);
  }
  
  fullscreenContainer.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeFullscreenAnswers() {
  const fullscreenContainer = document.getElementById('fullscreenAnswers');
  fullscreenContainer.classList.add('hidden');
  document.body.style.overflow = '';
  document.getElementById('hostSection').classList.remove('hidden');
}

function generateFullscreenAnswersHTML(answers, participants) {
  const answersArray = Object.entries(answers)
    .map(([name, answerData]) => ({
      name,
      ...answerData
    }))
    .sort((a, b) => a.timestamp - b.timestamp);

  let html = '';
  
  answersArray.forEach((answer, index) => {
    const participant = participants[answer.name] || {};
    const isLate = participant.late || false;
    const studentColor = getStudentColor(answer.name);
    
    const timestamp = new Date(answer.timestamp);
    const timeString = timestamp.toLocaleTimeString([], {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
    
    // Use text directly as HTML for tables, or replace newlines for text
    let displayContent = answer.text;
    if (!displayContent.includes('<table')) {
       displayContent = displayContent.replace(/\n/g, '<br>');
    }
    
    html += `
      <div class="fullscreen-answer-card student-card p-6 rounded-xl ${isLate ? 'late' : 'answered'} fade-in" 
           data-student="${answer.name}"
           style="border-color: ${studentColor.border}; background-color: ${studentColor.bg};">
        <div class="editing-indicator">
          <i class="fas fa-edit mr-1"></i>編輯中
        </div>
        <div class="flex justify-between items-start mb-4">
          <div class="font-medium text-xl flex items-center">
            ${isLate ? '<i class="fas fa-clock text-red-500 mr-2 text-xl"></i>' : '<i class="fas fa-check-circle text-moss-green mr-2 text-xl"></i>'}
            <span class="student-name-tag text-lg px-4 py-2" style="background-color: ${studentColor.border}15; color: ${studentColor.border};">${answer.name}</span>
          </div>
          <div class="text-base text-wabi-secondary bg-earth-beige px-4 py-2 rounded-full font-medium">
            ${timeString} ${isLate ? '(超時)' : ''}
          </div>
        </div>
        
        <div class="answer-display mt-4 text-left text-xl" 
             data-student="${answer.name}" 
             contenteditable="false"
             spellcheck="false">
          ${displayContent}
        </div>
        
        <div class="save-status text-sm text-wabi-secondary mt-3 text-right hidden">
          <i class="fas fa-save mr-1"></i>已自動保存
        </div>
      </div>
    `;
  });
  
  return html;
}

function setupFullscreenEditing(answers, participants) {
  const answerCards = document.querySelectorAll('.fullscreen-answer-card');
  answerCards.forEach(card => {
    const studentName = card.getAttribute('data-student');
    setupDoubleClickEditing(card, studentName);
  });
}

function updateAnswersList(answers, participants) {
  const answersList = document.getElementById('answersList');
  const currentAnswers = JSON.stringify(answers || {});
  const lastAnswers = answersList.getAttribute('data-last-answers') || '{}';
  
  if (currentAnswers === lastAnswers) return;
  answersList.setAttribute('data-last-answers', currentAnswers);
  answersList.innerHTML = '';
  
  if (!sessionActive) {
    answersList.innerHTML += '<div class="text-center py-12 text-wabi-secondary">尚未開始</div>';
    return;
  }
  
  if (!answers || Object.keys(answers).length === 0) {
    answersList.innerHTML += '<div class="text-center py-12 text-wabi-secondary">尚未有回答</div>';
    return;
  }

  const answersArray = Object.entries(answers)
    .map(([name, answerData]) => ({
      name,
      ...answerData
    }))
    .sort((a, b) => a.timestamp - b.timestamp);

  answersArray.forEach((answer, index) => {
    const participant = participants[answer.name] || {};
    const isLate = participant.late || false;
    const studentColor = getStudentColor(answer.name);
    
    const div = document.createElement('div');
    div.className = `student-card p-5 rounded-xl ${isLate ? 'late' : 'answered'} fade-in`;
    div.style.borderColor = studentColor.border;
    div.style.backgroundColor = studentColor.bg;

    const timestamp = new Date(answer.timestamp);
    const timeString = timestamp.toLocaleTimeString([], {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });

    // Check if answer is an HTML table or plain text
    let displayContent = answer.text;
    if (!displayContent.includes('<table')) {
       // If strictly text, convert newlines to <br>
       displayContent = displayContent.replace(/\n/g, '<br>');
    }
    
    div.innerHTML = `
      <div class="editing-indicator">
        <i class="fas fa-edit mr-1"></i>編輯中
      </div>
      <div class="flex justify-between items-start mb-3">
        <div class="font-medium text-lg flex items-center">
          ${isLate ? '<i class="fas fa-clock text-red-500 mr-2 text-lg"></i>' : '<i class="fas fa-check-circle text-moss-green mr-2 text-lg"></i>'}
          <span class="student-name-tag" style="background-color: ${studentColor.border}15; color: ${studentColor.border};">${answer.name}</span>
        </div>
        <div class="text-sm text-wabi-secondary bg-earth-beige px-3.5 py-1.5 rounded-full font-medium">
          ${timeString} ${isLate ? '(超時)' : ''}
        </div>
      </div>
      
      <div class="answer-display mt-3 text-left text-base" 
           data-student="${answer.name}" 
           contenteditable="false"
           spellcheck="false">
        ${displayContent}
      </div>
      
      <div class="save-status text-xs text-wabi-secondary mt-2 text-right hidden">
        <i class="fas fa-save mr-1"></i>已自動保存
      </div>
    `;
    
    answersList.appendChild(div);
    if (isHost) {
      setupDoubleClickEditing(div, answer.name);
    }
  });
}

async function startSession() {
  if (!isHost || !currentRoom) return;
  
  const question = document.getElementById('questionInput').value.trim();
  if (!question) {
    alert('請輸入問題內容');
    return;
  }
  
  const minutes = parseInt(document.getElementById('minutesInput').value) || 0;
  const seconds = parseInt(document.getElementById('secondsInput').value) || 0;
  timeLimit = minutes * 60 + seconds;
  
  if (timeLimit <= 0) {
    alert('請設定有效的時間');
    return;
  }
  
  const sessionRef = database.ref('class_rooms/' + currentRoom + '/session');
  const sessionSnapshot = await sessionRef.once('value');
  const currentSession = sessionSnapshot.val();
  
  if (currentSession.active) {
    clearInterval(timer);
    timer = null;
    await sessionRef.update({
      active: false
    });
    sessionActive = false;
    document.getElementById('hostCountdownContainer').classList.add('hidden');
  } else {
    clearInterval(timer);
    timer = null;
    
    const newQuestionId = Date.now();
    currentQuestionId = newQuestionId;
    
    // Gather config
    const mode = document.querySelector('input[name="questionMode"]:checked').value;
    const outlineType = document.querySelector('input[name="outlineType"]:checked').value;
    // Host only sends the mode and the general type. Structure and segments are decided by student.
    
    const outlineConfig = {
        type: outlineType
    };

    await database.ref('class_rooms/' + currentRoom).update({
      answers: {}, 
      session: {
        active: true,
        question: question,
        questionId: newQuestionId,
        timeLimit: timeLimit,
        startTime: firebase.database.ServerValue.TIMESTAMP,
        endTime: null,
        mode: mode,
        outlineConfig: outlineConfig
      }
    });
    
    const participantsRef = database.ref('class_rooms/' + currentRoom + '/participants');
    const participantsSnapshot = await participantsRef.once('value');
    const participants = participantsSnapshot.val() || {};
    
    for (const name in participants) {
      if (participants.hasOwnProperty(name)) {
        await participantsRef.child(name).update({
          submitted: false,
          late: false,
          lastQuestionId: newQuestionId
        });
      }
    }
    
    sessionActive = true;
    remainingTime = timeLimit;
    
    updateCountdownDisplay(remainingTime);
    document.getElementById('hostCountdownContainer').classList.remove('hidden');
  }
}

async function endSession() {
if (!isHost || !currentRoom) return;
clearInterval(timer);
timer = null;
sessionActive = false;
await database.ref('class_rooms/' + currentRoom + '/session').update({
active: false,
endTime: firebase.database.ServerValue.TIMESTAMP
});
document.getElementById('hostCountdownContainer').classList.add('hidden');
}

async function clearSession() {
if (!isHost || !currentRoom) return;
clearInterval(timer);
timer = null;
sessionActive = false;
await database.ref('class_rooms/' + currentRoom).update({
session: {
active: false,
question: "",
questionId: Date.now(), 
timeLimit: 600,
startTime: null,
endTime: null
},
answers: {}
});

const participantsRef = database.ref('class_rooms/' + currentRoom + '/participants');
const participantsSnapshot = await participantsRef.once('value');
const participants = participantsSnapshot.val() || {};
for (const name in participants) {
if (participants.hasOwnProperty(name)) {
await participantsRef.child(name).update({
submitted: false,
late: false,
lastQuestionId: null
});
}
}

remainingTime = 600;
updateCountdownDisplay(remainingTime);
document.getElementById('hostCountdownContainer').classList.add('hidden');
document.getElementById('questionInput').value = '';
document.getElementById('minutesInput').value = '10';
document.getElementById('secondsInput').value = '0';
}

async function submitAnswer() {
  if (!currentRoom || !currentUser || isHost || hasSubmitted) return;
  
  let answerText = '';
  const container = document.getElementById('studentInputContainer');
  const table = container.querySelector('table');
  
  if (table) {
    // Format Table Inputs into HTML string
    const clonedTable = table.cloneNode(true);
    const textareas = table.querySelectorAll('textarea');
    const clonedCells = clonedTable.querySelectorAll('textarea');
    
    // Convert textarea values to text/html inside cell
    for (let i = 0; i < textareas.length; i++) {
        const val = textareas[i].value || '';
        const parent = clonedCells[i].parentNode;
        // Replace textarea with div or simple text
        parent.innerHTML = val.replace(/\n/g, '<br>');
    }
    
    // Add styles to ensure it looks good on host side
    clonedTable.classList.add('rendered-outline-table');
    answerText = clonedTable.outerHTML;
  } else {
    answerText = document.getElementById('studentAnswer').value.trim();
  }

  // Standard checks on content existence (simple check)
  if (table) {
     let hasContent = false;
     container.querySelectorAll('textarea').forEach(t => { if(t.value.trim()) hasContent = true; });
     if(!hasContent) { alert('請填寫大綱內容'); return; }
  } else {
     if(!answerText) { alert('請輸入答案'); return; }
  }

  try {
    const roomSnapshot = await database.ref('class_rooms/' + currentRoom).once('value');
    const roomData = roomSnapshot.val();
    let isLate = false;
    if (roomData.session.active && roomData.session.startTime) {
      const startTime = roomData.session.startTime;
      const currentTime = Date.now();
      const elapsed = Math.floor((currentTime - startTime) / 1000);
      isLate = elapsed > roomData.session.timeLimit;
    }

    if (remainingTime <= 0) {
      alert('時間已到,無法提交答案');
      return;
    }

    const answerData = {
      text: answerText,
      timestamp: firebase.database.ServerValue.TIMESTAMP,
      late: isLate
    };
    await database.ref('class_rooms/' + currentRoom + '/answers/' + currentUser).set(answerData);

    await database.ref('class_rooms/' + currentRoom + '/participants/' + currentUser).update({
      submitted: true,
      late: isLate,
      lastQuestionId: roomData.session.questionId
    });

    hasSubmitted = true;
    const submissionStatus = document.getElementById('submissionStatus');
    const answerInputArea = document.getElementById('answerInputArea');
    submissionStatus.classList.remove('hidden');
    
    // Disable inputs
    if(table) {
       container.querySelectorAll('textarea').forEach(t => t.disabled = true);
    } else {
       document.getElementById('studentAnswer').disabled = true;
    }
    
    document.getElementById('submitBtn').classList.add('hidden');
    answerInputArea.classList.add('submitted');
    if (isLate) {
      answerInputArea.classList.add('late');
      submissionStatus.innerHTML = '<i class="fas fa-clock text-red-500 mr-2"></i>已超時提交';
    }
  } catch (error) {
    console.error('提交答案失敗:', error);
    alert('提交答案失敗,請重試');
  }
}

async function leaveHost() {
if (roomRef) {
roomRef.off();
roomRef = null;
}
if (currentRoom) {
await database.ref('class_rooms/' + currentRoom).remove();
}
clearInterval(timer);
timer = null;
sessionActive = false;
document.getElementById('hostCountdownContainer').classList.add('hidden');
currentRoom = null;
currentUser = null;
isHost = false;
showMainMenu();
}

async function leaveStudent() {
if (roomRef) {
roomRef.off();
roomRef = null;
}
if (currentRoom && currentUser) {
await database.ref('class_rooms/' + currentRoom + '/participants/' + currentUser).remove();
}
clearInterval(timer);
timer = null;
sessionActive = false;
currentRoom = null;
currentUser = null;
isHost = false;
hasSubmitted = false;
showMainMenu();
}

// Modal Logic
let currentEditingElement = null;
const modal = document.getElementById('outline-editor-modal');
const modalTextarea = document.getElementById('modal-textarea');
const modalSaveBtn = document.getElementById('modal-save-btn');
const modalCloseBtn = document.getElementById('modal-close-btn');

function openModalEditor(element) {
    currentEditingElement = element;
    modalTextarea.value = element.value;
    modal.style.display = 'flex';
    modalTextarea.focus();
}

function closeModalEditor() {
    modal.style.display = 'none';
    currentEditingElement = null;
}

function saveAndCloseEditor() {
    if (currentEditingElement) {
        currentEditingElement.value = modalTextarea.value;
    }
    closeModalEditor();
}

document.body.addEventListener('click', function(event) {
    const target = event.target;
    if (target.tagName === 'TEXTAREA' && !target.classList.contains('no-modal-editor') && target.id !== 'modal-textarea' && target.id !== 'questionInput') {
        // Exclude host's question input if desired, or let it open modal too
        // Ensure studentAnswer is covered
        if(!isHost || target.id === 'questionInput') { // Let host edit question too
             // Actually, prompt says "Student clicks input", but good UX applies to all small textareas
        }
        
        // Specifically for student section textareas
        if(document.getElementById('studentSection').contains(target)) {
             openModalEditor(target);
        }
    }
});

modalSaveBtn.addEventListener('click', saveAndCloseEditor);
modalCloseBtn.addEventListener('click', closeModalEditor);
modal.addEventListener('click', function(event) {
    if (event.target === modal) {
        closeModalEditor();
    }
});
// End Modal Logic

window.addEventListener('beforeunload', () => {
  clearInterval(timer);
  timer = null;
  if (currentRoom && currentUser) {
    if (isHost) {
      database.ref('class_rooms/' + currentRoom).remove();
    } else {
      database.ref('class_rooms/' + currentRoom + '/participants/' + currentUser).remove();
    }
  }
});

document.addEventListener('DOMContentLoaded', () => {
  timer = null;
  setupFullscreenAnswers();
  
  const studentAnswer = document.getElementById('studentAnswer');
  if (studentAnswer) {
    studentAnswer.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = this.scrollHeight + 'px';
    });
    studentAnswer.style.height = 'auto';
    studentAnswer.style.height = studentAnswer.scrollHeight + 'px';
  }
   
  const urlParams = new URLSearchParams(window.location.search);
  const roomCode = urlParams.get('room');
  if (roomCode && roomCode.length === 6) {
    document.getElementById('joinRoomCode').value = roomCode;
    showJoinSection();
  } else {
    showMainMenu();
  }
});

document.getElementById('fullscreenToggle').addEventListener('click', function() {
  if (!currentRoom) return;
  const roomRef = database.ref('class_rooms/' + currentRoom);
  roomRef.once('value').then(snapshot => {
    const roomData = snapshot.val();
    if (roomData && roomData.answers) {
      openFullscreenAnswers(roomData.answers, roomData.participants);
    }
  }).catch(error => {
    console.error('獲取全屏數據失敗:', error);
  });
});

</script>
<footer class="copyright-footer">
<p>Copyright © 2025 陳冠健. All rights reserved.</p>
</footer>

<!-- 全屏回答檢視 -->
<div id="fullscreenAnswers" class="fixed inset-0 bg-paper z-50 hidden flex flex-col">
  <!-- 頂部工具欄 -->
  <div class="bg-paper border-b border-stone-gray border-opacity-20 p-4 flex justify-between items-center shadow-sm">
    <h2 class="text-2xl font-bold text-charcoal">
      <i class="fas fa-comments text-clay-brown mr-3"></i>
      學生回答列表
    </h2>
    <div class="flex items-center gap-3">
      <!-- 字體控制按鈕 -->
      <div class="font-controls">
        <button class="font-btn decrease-font" title="縮小字體">
          <i class="fas fa-font"></i>
        </button>
        <button class="font-btn increase-font" title="放大字體">
          <i class="fas fa-font"></i><i class="fas fa-plus" style="font-size: 0.6em; margin-left: -2px;"></i>
        </button>
        <!-- 關閉按鈕 -->
        <button id="closeFullscreen" class="fullscreen-toggle-btn" title="關閉全屏">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>
 
  <!-- 回答列表容器 -->
  <div id="fullscreenAnswersList" class="flex-1 overflow-y-auto p-6 bg-earth-beige">
    <!-- 回答將在這裡動態生成 -->
  </div>
</div>
    
</body>
</html>
