<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>脈問堂</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/firebase-app-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<style>
:root {
--earth-beige: #f9f6f1;
--clay-brown: #8a7663;
--stone-gray: #82827a;
--moss-green: #5f6e55;
--charcoal: #383833;
--shadow: #2a2a25;
--text-primary: #333330;
--text-secondary: #686863;
--paper: #fdfcf8;
--border-radius: 16px;
--box-shadow: 0 8px 30px rgba(0, 0, 0, 0.07);
--transition: all 0.35s cubic-bezier(0.23, 1, 0.32, 1);
--transition-fast: all 0.2s cubic-bezier(0.23, 1, 0.32, 1);
--primary-gradient: linear-gradient(135deg, var(--clay-brown), var(--charcoal));
--secondary-gradient: linear-gradient(135deg, var(--moss-green), #535f4c);
}

* {
  transition: var(--transition-fast);
}

body {
  font-family: 'Noto Serif TC', serif;
  background: var(--earth-beige);
  color: var(--text-primary);
  min-height: 100vh;
  background-attachment: fixed;
  line-height: 1.6;
  position: relative;
}

body::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: none;
  z-index: -2;
}

.wabi-sabi-card {
  background: var(--paper);
  border: 1px solid rgba(141, 123, 104, 0.15);
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.wabi-sabi-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--moss-green), var(--clay-brown));
  opacity: 0.85;
}

.wabi-sabi-button {
  background: var(--earth-beige);
  color: var(--charcoal);
  border: 1px solid rgba(141, 123, 104, 0.3);
  border-radius: var(--border-radius);
  padding: 13px 26px;
  font-family: 'Inter', sans-serif;
  font-weight: 600;
  letter-spacing: 0.5px;
  transition: var(--transition);
  cursor: pointer;
  position: relative;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.wabi-sabi-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.2);
  transform: translateY(100%);
  transition: transform 0.3s ease;
  z-index: 0;
}

.wabi-sabi-button:hover::before {
  transform: translateY(0);
}

.wabi-sabi-button span {
  position: relative;
  z-index: 1;
}

.wabi-sabi-button:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.wabi-sabi-button:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.wabi-sabi-button.primary {
  background: var(--primary-gradient);
  color: white;
  border: none;
  box-shadow: 0 4px 12px rgba(138, 118, 99, 0.3);
}

.wabi-sabi-button.primary:hover {
  box-shadow: 0 6px 18px rgba(138, 118, 99, 0.4);
}

.wabi-sabi-button.primary:active {
  transform: translateY(1px);
  box-shadow: 0 2px 8px rgba(138, 118, 99, 0.35);
}

.wabi-sabi-button.danger {
  background: linear-gradient(135deg, #a86b6b, #8b5555);
  color: white;
  border: none;
  box-shadow: 0 4px 12px rgba(168, 107, 107, 0.3);
}

.wabi-sabi-button.danger:hover {
  box-shadow: 0 6px 18px rgba(168, 107, 107, 0.4);
}

.input-field {
  background-color: var(--earth-beige);
  border: 1px solid rgba(126, 126, 118, 0.3);
  color: var(--text-primary);
  border-radius: 14px;
  padding: 14px 18px;
  font-family: 'Inter', sans-serif;
  font-weight: 500;
  transition: var(--transition);
  box-shadow: 0 2px 4px rgba(0,0,0,0.03);
}

    #studentAnswer {
  min-height: 300px; /* 大幅增加初始高度，例如從 160px 改成 300px 或更大，視需求調整 */
  overflow: hidden; /* 隱藏滾動條 */
  resize: none; /* 禁止用戶手動調整大小 */
  white-space: pre-wrap; /* 確保自動換行並保留空白 */
  word-wrap: break-word; /* 長單詞自動斷行 */
}

.input-field:focus {
  outline: none;
  border-color: var(--clay-brown);
  box-shadow: 0 0 0 3px rgba(138, 118, 99, 0.2);
  background-color: var(--earth-beige);
}

.input-field::placeholder {
  color: var(--text-secondary);
  opacity: 0.7;
  font-weight: 400;
}

.qr-section {
  background: var(--earth-beige);
  border: 2px solid rgba(126, 126, 118, 0.25);
  border-radius: var(--border-radius);
  padding: 28px;
  text-align: center;
  box-shadow: inset 0 0 15px rgba(0,0,0,0.03);
  transition: var(--transition);
}

.qr-section:hover {
  box-shadow: 0 0 20px rgba(0,0,0,0.05), inset 0 0 15px rgba(0,0,0,0.05);
}

.countdown-display {
  font-family: 'Inter', sans-serif;
  font-size: 4.2rem;
  font-weight: 700;
  color: var(--charcoal);
  text-shadow: 0 2px 4px rgba(0,0,0,0.08);
  letter-spacing: -1.5px;
  position: relative;
  line-height: 1;
}

.countdown-display::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 80%;
  height: 3px;
  background: var(--primary-gradient);
  border-radius: 3px;
  opacity: 0.8;
}

.student-card {
  transition: var(--transition);
  border-left-width: 4px;
  background-color: var(--earth-beige);
  position: relative;
  overflow: hidden;
  box-shadow: 0 3px 10px rgba(0,0,0,0.04);
  cursor: pointer;
}

.student-card.answered {
  border-left-color: var(--moss-green);
}

.student-card.late {
  border-left-color: #a86b6b;
}

.student-card:hover {
  transform: translateX(5px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.08);
}

.student-answer {
  background: var(--paper);
  border-radius: 10px;
  padding: 8px;
  font-size: 1.5rem;
  line-height: 1.8;
  line-height: 1.8; /* 添加這行，增加行距 */
  border: 1px solid rgba(126, 126, 118, 0.15);
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.question-display {
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  background: var(--earth-beige);
  border-radius: var(--border-radius);
  border: 1px dashed rgba(141, 123, 104, 0.4);
  margin-bottom: 24px;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
  font-family: 'Inter', sans-serif;
  font-weight: 500;
  font-size: 1.25rem;
  line-height: 1.5;
}

.question-display span {
  position: relative;
  z-index: 1;
}

.copy-success {
  background: rgba(95, 110, 85, 0.15);
  border-color: var(--moss-green);
  color: var(--moss-green);
  box-shadow: 0 0 12px rgba(95, 110, 85, 0.2);
}

.answer-input-area {
  transition: var(--transition);
  position: relative;
}

.answer-input-area.submitted {
  transform: scale(0.98);
  opacity: 0.95;
  box-shadow: 0 0 15px rgba(95, 110, 85, 0.2);
}

.answer-input-area.late {
  border-left: 4px solid #a86b6b;
  box-shadow: 0 0 15px rgba(168, 107, 107, 0.2);
}

.text-wabi {
  color: var(--clay-brown);
  font-family: 'Inter', sans-serif;
  font-weight: 600;
}

.text-wabi-secondary {
  color: var(--text-secondary);
  font-family: 'Inter', sans-serif;
  font-weight: 400;
}

.icon-shadow {
  text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.12);
  transition: var(--transition-fast);
}

.fade-in {
  animation: fadeIn 0.6s ease-out forwards;
}

@keyframes fadeIn {
  from { 
    opacity: 0; 
    transform: translateY(10px);
  }
  to { 
    opacity: 1; 
    transform: translateY(0);
  }
}

.time-input-group {
  display: flex;
  align-items: center;
  gap: 16px;
  background: var(--earth-beige);
  border: 1px solid rgba(141, 123, 104, 0.3);
  border-radius: var(--border-radius);
  padding: 14px 18px;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
}

.time-input {
  width: 75px;
  background: transparent;
  border: none;
  text-align: center;
  font-family: 'Inter', sans-serif;
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--charcoal);
  padding: 6px 0;
  position: relative;
  z-index: 1;
}

.time-input:focus {
  outline: none;
  box-shadow: none;
}

.time-input::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 2px;
  background: var(--clay-brown);
  transition: width 0.3s ease;
  z-index: 0;
}

.time-input:focus::after {
  width: 80%;
}

.time-unit {
  color: var(--stone-gray);
  font-weight: 600;
  font-size: 1.2rem;
  font-family: 'Inter', sans-serif;
  letter-spacing: 0.5px;
}

.room-code {
  font-family: 'Inter', sans-serif;
  font-size: 1.65rem;
  color: var(--clay-brown);
  letter-spacing: 2px;
  font-weight: 700;
  text-shadow: 0 1px 2px rgba(0,0,0,0.05);
  position: relative;
  display: inline-block;
}

.room-code::after {
  content: '';
  position: absolute;
  bottom: -4px;
  left: 0;
  width: 100%;
  height: 2px;
  background: var(--moss-green);
  opacity: 0.7;
}

.copyright-footer {
  position: fixed;
  bottom: 12px;
  right: 12px;
  padding: 6px 15px;
  background: var(--earth-beige);
  color: var(--charcoal);
  border-radius: 12px 0 0 0;
  border: 1px solid rgba(141, 123, 104, 0.25);
  font-family: 'Inter', sans-serif;
  font-size: 0.8rem;
  z-index: 100;
  box-shadow: -2px -2px 8px rgba(0,0,0,0.05);
  transition: var(--transition);
}

.copyright-footer:hover {
  transform: translateX(-3px);
  box-shadow: -3px -3px 12px rgba(0,0,0,0.08);
}

.host-countdown-container {
  text-align: center;
  padding: 20px;
  background: rgba(138, 118, 99, 0.04);
  border-radius: var(--border-radius);
  margin-top: 24px;
  min-height: 90px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid rgba(141, 123, 104, 0.2);
  position: relative;
  overflow: hidden;
}

.host-countdown {
  font-family: 'Inter', sans-serif;
  font-size: 3.6rem;
  font-weight: 700;
  color: var(--charcoal);
  text-shadow: 0 2px 4px rgba(0,0,0,0.08);
  letter-spacing: -1px;
  position: relative;
  z-index: 1;
  line-height: 1;
}

.time-control-container {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-bottom: 8px;
}

@media (min-width: 768px) {
  .time-control-container {
    flex-direction: row;
    align-items: flex-end;
  }
  .time-input-wrapper {
    flex: 1;
  }
}

.time-button-wrapper {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 8px;
  position: relative;
  z-index: 10;
}

.question-title {
  font-family: 'Inter', sans-serif;
  font-size: 1.45rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.time-title {
  font-family: 'Inter', sans-serif;
  font-size: 1.15rem;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

#participantsStatus {
  scrollbar-width: thin;
  scrollbar-color: var(--stone-gray) transparent;
}

#participantsStatus::-webkit-scrollbar {
  width: 6px;
}

#participantsStatus::-webkit-scrollbar-track {
  background: transparent;
}

#participantsStatus::-webkit-scrollbar-thumb {
  background-color: var(--stone-gray);
  border-radius: 3px;
}

#answersList {
  scrollbar-width: thin;
  scrollbar-color: var(--stone-gray) transparent;
}

#answersList::-webkit-scrollbar {
  width: 6px;
}

#answersList::-webkit-scrollbar-track {
  background: transparent;
}

#answersList::-webkit-scrollbar-thumb {
  background-color: var(--stone-gray);
  border-radius: 3px;
}

.card-header {
  display: flex;
  align-items: center;
  gap: 10px;
}

.card-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: rgba(138, 118, 99, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--clay-brown);
}

#submitBtn {
  position: relative;
  overflow: hidden;
}

#submitBtn::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.6s;
}

#submitBtn:hover::after {
  left: 100%;
}

.section-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  margin-bottom: 2rem;
}

.section-title {
  font-family: 'Inter', sans-serif;
  font-size: 2.2rem;
  font-weight: 700;
  color: var(--charcoal);
  margin-bottom: 0.5rem;
}

.section-subtitle {
  color: var(--text-secondary);
  font-family: 'Inter', sans-serif;
  font-size: 1.1rem;
}

.role-button {
  transition: var(--transition);
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;
}

.role-button::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(45deg, var(--clay-brown), var(--moss-green));
  z-index: 0;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.role-button:hover::before {
  opacity: 1;
}

.role-button span {
  position: relative;
  z-index: 2;
}

.role-icon {
  font-size: 2.8rem;
  margin-bottom: 1rem;
  transition: var(--transition);
}

.role-button:hover .role-icon {
  transform: scale(1.1);
}

.role-title {
  font-family: 'Inter', sans-serif;
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.role-desc {
  font-family: 'Inter', sans-serif;
  color: var(--text-secondary);
}

/* 修改主持人按鈕樣式 */
.role-button.primary {
  background: rgba(138, 118, 99, 0.1); /* 淺棕色背景 */
  border: 1px solid rgba(138, 118, 99, 0.3);
}

.role-button.primary:hover {
  background: rgba(138, 118, 99, 0.15); /* 懸停時加深背景 */
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(138, 118, 99, 0.25);
}

/* 修改主持人圖標顏色 */
.role-button.primary .role-icon {
  color: var(--clay-brown); /* 深棕色圖標 */
}

/* 修改主持人文字顏色 */
.role-button.primary .role-title,
.role-button.primary .role-desc {
  color: var(--charcoal); /* 深灰色文字確保可讀性 */
}

@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.9; }
  100% { transform: scale(1); opacity: 1; }
}

.pulse {
  animation: pulse 2s infinite;
}

.glow-effect {
  box-shadow: 0 0 15px rgba(138, 118, 99, 0.2);
}

.wabi-sabi-button:hover .icon-shadow {
  transform: scale(1.1);
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

@keyframes fadeInScale {
  from { 
    opacity: 0; 
    transform: scale(0.95);
  }
  to { 
    opacity: 1; 
    transform: scale(1);
  }
}

.fade-in-scale {
  animation: fadeInScale 0.5s ease-out forwards;
}

.floating {
  animation: float 3s ease-in-out infinite;
}

@media (max-width: 768px) {
  .countdown-display {
    font-size: 3.2rem;
  }
  .host-countdown {
    font-size: 2.8rem;
  }
  .section-title {
    font-size: 1.8rem;
  }
  .role-button {
    padding: 1.5rem;
  }
  .role-icon {
    font-size: 2.2rem;
  }
  .time-input {
    width: 60px;
    font-size: 1.1rem;
  }
}

@media (max-width: 480px) {
  .countdown-display {
    font-size: 2.8rem;
  }
  .host-countdown {
    font-size: 2.4rem;
  }
  .section-title {
    font-size: 1.6rem;
  }
  .role-button {
    padding: 1.2rem;
  }
  .role-icon {
    font-size: 1.8rem;
  }
  .time-input-group {
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }
  .time-input {
    width: 80px;
  }
}

/* 編輯模態框樣式 */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.modal-overlay.active {
  opacity: 1;
  pointer-events: all;
}

.modal-content {
  background: var(--paper);
  border-radius: var(--border-radius);
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  transform: translateY(20px);
  transition: transform 0.3s ease;
  position: relative;
}

.modal-overlay.active .modal-content {
  transform: translateY(0);
}

.modal-header {
  padding: 20px;
  border-bottom: 1px solid rgba(141, 123, 104, 0.2);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-family: 'Inter', sans-serif;
  font-size: 1.4rem;
  font-weight: 600;
  color: var(--charcoal);
}

.close-modal {
  background: none;
  border: none;
  color: var(--stone-gray);
  font-size: 1.5rem;
  cursor: pointer;
  transition: color 0.2s;
}

.close-modal:hover {
  color: var(--clay-brown);
}

.modal-body {
  padding: 20px;
}

.modal-footer {
  padding: 20px;
  border-top: 1px solid rgba(141, 123, 104, 0.2);
  display: flex;
  justify-content: flex-end;
  gap: 15px;
}

.answer-editor {
  width: 100%;
  min-height: 150px;
  padding: 15px;
  border: 1px solid rgba(141, 123, 104, 0.3);
  border-radius: 12px;
  font-family: 'Noto Serif TC', serif;
  font-size: 1.1rem;
  resize: vertical;
  background: var(--earth-beige);
  color: var(--text-primary);
}

.answer-editor:focus {
  outline: none;
  border-color: var(--clay-brown);
  box-shadow: 0 0 0 3px rgba(138, 118, 99, 0.2);
}

.student-name-tag {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 500;
  margin-bottom: 8px;
}

.edit-icon {
  position: absolute;
  top: 10px;
  right: 10px;
  color: var(--stone-gray);
  font-size: 1.2rem;
  opacity: 0;
  transition: opacity 0.2s;
}

.student-card:hover .edit-icon {
  opacity: 1;
}

/* 可編輯的學生答案樣式 */
/* 可編輯的學生答案樣式 */
.student-answer.editable {
  cursor: text;
  padding: 12px;
  border: 1px dashed rgba(138, 118, 99, 0.3);
  border-radius: 10px;
  transition: var(--transition);
  min-height: 60px;
  background: var(--paper);
  white-space: pre-wrap; /* 保留空白和換行 */
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.student-answer.editable:focus {
  outline: none;
  border: 1px solid var(--clay-brown);
  box-shadow: 0 0 0 2px rgba(138, 118, 99, 0.2);
  background: var(--earth-beige);
}

.student-answer.editable:hover {
  border-color: var(--clay-brown);
  background: var(--earth-beige);
}

/* 編輯按鈕樣式 - 隱藏 */
.edit-actions {
  display: none; /* 完全隱藏編輯按鈕 */
}

.student-card.editing .edit-actions {
  display: flex; /* 只在編輯模式下顯示 */
}

/* 可編輯的學生答案樣式 */
.answer-display {
  cursor: text;
  padding: 8px;
  border: 1px solid transparent;
  border-radius: 10px;
  transition: var(--transition);
  min-height: 60px;
  background: var(--paper);
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-wrap: break-word;
  outline: none;
  font-size: 1.5rem; /* 添加這行，約 24px */
  line-height: 1.8; /* 添加這行，增加行距 */
}

.answer-display:hover {
  background-color: rgba(138, 118, 99, 0.05);
  border: 1px dashed rgba(138, 118, 99, 0.3);
}

.answer-display:focus {
  background-color: var(--earth-beige);
  border: 1px solid var(--clay-brown);
  box-shadow: 0 0 0 2px rgba(138, 118, 99, 0.2);
}

/* 編輯狀態指示器 */
.editing-indicator {
  position: absolute;
  top: 10px;
  right: 10px;
  background: var(--moss-green);
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  font-weight: 500;
  opacity: 0;
  transition: opacity 0.3s;
}

.student-card.editing .editing-indicator {
  opacity: 1;
}

/* 全屏模式樣式 */
#fullscreenAnswers {
  transition: opacity 0.3s ease;
  background: var(--paper);
}

#fullscreenAnswers:not(.hidden) {
  display: flex !important;
}


.fullscreen-answer-card {
  background: var(--paper);
  border: 1px solid rgba(141, 123, 104, 0.15);
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
  margin-bottom: 1.5rem;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
  cursor: pointer;
}

.fullscreen-answer-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--moss-green), var(--clay-brown));
  opacity: 0.85;
}

.fullscreen-answer-content {
  padding: 0.8rem; /* 約 13px */
  font-size: 1.1rem;
  line-height: 1.7;
  white-space: pre-wrap;
  word-wrap: break-word;
  min-height: 120px;
}

/* 全屏編輯模式 */
.fullscreen-answer-card.editing {
  border: 2px solid var(--clay-brown);
  box-shadow: 0 0 20px rgba(138, 118, 99, 0.2);
}

.fullscreen-editor {
  width: 100%;
  min-height: 200px;
  padding: 0.8rem;
  border: 1px solid rgba(141, 123, 104, 0.3);
  border-radius: 12px;
  font-family: 'Noto Serif TC', serif;
  font-size: 1.1rem;
  resize: vertical;
  background: var(--earth-beige);
  color: var(--text-primary);
  line-height: 1.7;
}

.fullscreen-editor:focus {
  outline: none;
  border-color: var(--clay-brown);
  box-shadow: 0 0 0 3px rgba(138, 118, 99, 0.2);
}

/* 全屏編輯操作按鈕 */
.fullscreen-edit-actions {
  position: absolute;
  top: 1rem;
  right: 1rem;
  opacity: 0;
  transition: opacity 0.3s;
  display: flex;
  gap: 0.5rem;
}

.fullscreen-answer-card:hover .fullscreen-edit-actions {
  opacity: 1;
}

.fullscreen-answer-card.editing .fullscreen-edit-actions {
  opacity: 1;
}

.fullscreen-edit-btn, .fullscreen-save-btn, .fullscreen-cancel-btn {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  cursor: pointer;
  transition: var(--transition);
  font-size: 1rem;
}

.fullscreen-edit-btn {
  background: rgba(138, 118, 99, 0.1);
  color: var(--clay-brown);
}

.fullscreen-edit-btn:hover {
  background: rgba(138, 118, 99, 0.2);
  transform: scale(1.1);
}

.fullscreen-save-btn {
  background: var(--moss-green);
  color: white;
}

.fullscreen-save-btn:hover {
  background: #4a5a42;
  transform: scale(1.1);
}

.fullscreen-cancel-btn {
  background: rgba(168, 107, 107, 0.1);
  color: #a86b6b;
}

.fullscreen-cancel-btn:hover {
  background: rgba(168, 107, 107, 0.2);
  transform: scale(1.1);
}

/* 全屏保存狀態 */
.fullscreen-save-status {
  position: absolute;
  bottom: 1rem;
  right: 1rem;
  background: var(--moss-green);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.8rem;
  opacity: 0;
  transition: opacity 0.3s;
}

.fullscreen-save-status.show {
  opacity: 1;
}

    /* 全屏按鈕樣式 */
.fullscreen-toggle-btn {
  position: static; /* 從絕對定位改為靜態 */
  margin-left: auto; /* 自動外邊距推到右側 */
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--earth-beige);
  border: 1px solid rgba(141, 123, 104, 0.3);
  color: var(--clay-brown);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  flex-shrink: 0; /* 防止按鈕被壓縮 */
}

.fullscreen-toggle-btn:hover {
  transform: scale(1.1);
  background: rgba(138, 118, 99, 0.1);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  color: var(--charcoal);
}

/* 調整位置較上的全屏按鈕位置 */
.answers-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1rem;
  position: relative;
}

.answers-title-wrapper {
  display: flex;
  align-items: center;
  gap: 15px; /* 增加間距 */
  flex: 1; /* 佔用剩餘空間 */
}


    /* 將全屏按鈕移到更右側 */
#fullscreenToggle {
  margin-left: 30px; /* 增加左邊距，推到更右側 */
  order: 2; /* 確保在右側 */
}

/* 字體控制按鈕組 */
.font-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-left: auto; /* 推到右側 */
  order: 1; /* 在中間 */
}

/* 移除舊的定位樣式 */
#answersList {
  position: relative;
  padding-top: 10px; /* 移除這個，因為按鈕不再絕對定位 */
}

/* 全屏模式下的學生卡片樣式調整 */
#fullscreenAnswers .student-card {
  margin-bottom: 2rem;
  padding: 1.5rem;
  font-size: 1.1rem;
}

#fullscreenAnswers .answer-display {
  font-size: 1.2rem;
  line-height: 1.8;
  min-height: 150px;
  padding: 1rem;
}

#fullscreenAnswers .answer-display:hover {
  background-color: rgba(138, 118, 99, 0.05);
  border: 1px dashed rgba(138, 118, 99, 0.3);
}

#fullscreenAnswers .answer-display:focus {
  background-color: var(--earth-beige);
  border: 1px solid var(--clay-brown);
  box-shadow: 0 0 0 3px rgba(138, 118, 99, 0.2);
}

/* 字體控制按鈕樣式 */
.font-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-left: 15px;
}

.font-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--earth-beige);
  border: 1px solid rgba(141, 123, 104, 0.3);
  color: var(--clay-brown);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.9rem;
  font-weight: bold;
}

.font-btn:hover {
  background: rgba(138, 118, 99, 0.1);
  transform: scale(1.05);
}

.font-btn:active {
  transform: scale(0.95);
}

/* 全屏模式下的字體控制 */
#fullscreenAnswers .font-controls {
  margin-left: auto;
  margin-right: 15px;
}

#fullscreenAnswers .font-btn {
  width: 44px;
  height: 44px;
  font-size: 1.1rem;
}
    
    
</style>
</head>
<body>
<div class="container mx-auto px-4 py-10 max-w-6xl">
<!-- 主選單 -->
<div id="mainMenu" class="space-y-10">
<header class="section-header fade-in-scale">
<h1 class="section-title">
<i class="fas fa-brush text-clay-brown mr-3 icon-shadow"></i>
脈問堂
</h1>
<p class="section-subtitle">簡潔高效的課堂問答計時工具</p>
</header>
<div class="wabi-sabi-card p-8 fade-in" style="animation-delay: 0.2s">
<h2 class="text-2xl font-bold mb-8 text-center text-wabi">
<i class="fas fa-user-cog mr-3"></i>
選擇您的角色
</h2>
<div class="grid md:grid-cols-2 gap-8">
<button onclick="showHostSection()" class="role-button primary wabi-sabi-button p-7 rounded-xl text-center group">
<div class="transform transition-transform duration-300">
<i class="fas fa-user-tie role-icon text-moss-green"></i>
<div class="role-title">主持人</div>
<div class="role-desc">設置問題與計時</div>
</div>
</button>
<button onclick="showJoinSection()" class="role-button secondary wabi-sabi-button p-7 rounded-xl text-center group">
<div class="transform transition-transform duration-300">
<i class="fas fa-user-graduate role-icon text-moss-green"></i>
<div class="role-title">學生</div>
<div class="role-desc">加入問答</div>
</div>
</button>
</div>
</div>
</div>
<!-- 主持人介面 -->
<div id="hostSection" class="hidden space-y-8">
<header class="section-header fade-in-scale">
<h1 class="section-title">
<i class="fas fa-user-tie text-clay-brown mr-3"></i>
主持人介面
</h1>
<p class="section-subtitle">房間代碼: <span id="hostRoomCode" class="room-code"></span></p>
</header>
<div class="grid lg:grid-cols-2 gap-9">
<!-- 左側：QR Code & 控制 -->
<div class="space-y-9">
<div class="wabi-sabi-card p-7 fade-in">
<div class="card-header mb-5">
<div class="card-icon">
<i class="fas fa-qrcode"></i>
</div>
<h2 class="text-xl font-bold text-wabi">分享房間</h2>
</div>
<div class="qr-section">
<div class="mb-5">
<h3 class="text-xl font-bold text-wabi mb-2">掃描加入問答</h3>
<p class="text-wabi-secondary text-sm mb-4">學生可使用手機掃描此二維碼加入</p>
</div>
<div class="flex justify-center mb-5">
<canvas id="qrCanvas" class="bg-earth-beige p-5 rounded-xl border border-stone-gray shadow-md"></canvas>
</div>
<div class="space-y-4">
<button onclick="downloadQR()" class="wabi-sabi-button w-full py-3.5 rounded-xl font-medium">
<i class="fas fa-download mr-2"></i>保存二維碼
</button>
<button onclick="copyShareLink()" id="copyLinkBtn" class="wabi-sabi-button w-full py-3.5 rounded-xl font-medium">
<i class="fas fa-copy mr-2"></i>複製分享連結
</button>
</div>
</div>
</div>
<div class="wabi-sabi-card p-7 fade-in" style="animation-delay: 0.1s">
<div class="card-header mb-5">
<div class="card-icon">
<i class="fas fa-edit"></i>
</div>
<h2 class="text-xl font-bold text-wabi">問題設置</h2>
</div>
<div class="space-y-5">
<div>
<label class="block text-base font-medium text-wabi-secondary mb-2.5">問題內容</label>
<textarea id="questionInput" class="input-field w-full px-4.5 py-3.5 rounded-xl min-h-[110px] resize-y" placeholder="請在此輸入問題..."></textarea>
</div>
<div class="time-control-container">
<div class="time-input-wrapper">
<div class="time-title">計時設定</div>
<div class="time-input-group">
<input type="number" id="minutesInput" class="input-field time-input px-3 py-2.5" value="1" min="0">
<span class="time-unit">分</span>
<input type="number" id="secondsInput" class="input-field time-input px-3 py-2.5" value="0" min="0" max="59">
<span class="time-unit">秒</span>
</div>
</div>
<div class="time-button-wrapper">
<button id="startBtn" onclick="startSession()" class="wabi-sabi-button primary px-7 py-3.5 rounded-xl font-medium text-lg">
<i class="fas fa-play mr-2"></i>開始
</button>
</div>
</div>
<div class="host-countdown-container hidden" id="hostCountdownContainer">
<div class="host-countdown" id="hostCountdownDisplay">01:00</div>
</div>
</div>
</div>
</div>
<!-- 右側:學生回答列表 -->
<div class="space-y-9">
<div class="wabi-sabi-card p-7 fade-in">
<div class="card-header mb-5">
<div class="card-icon">
<i class="fas fa-users"></i>
</div>
<h2 class="text-xl font-bold text-wabi">參與學生
<span class="text-base font-normal text-wabi-secondary ml-2">(已加入: <span id="participantCount">0</span> 人)</span>
</h2>
</div>
<div id="participantsStatus" class="space-y-3 max-h-64 overflow-y-auto pr-2">
<!-- 學生狀態將在此顯示 -->
<div class="text-center py-10 text-wabi-secondary">尚未有人加入</div>
</div>
</div>
<!-- 修改這部分 -->
<div class="wabi-sabi-card p-7 fade-in" style="animation-delay: 0.1s">
  <div class="card-header mb-5">
    <div class="card-icon">
      <i class="fas fa-comments"></i>
    </div>
    <div class="answers-header">
  <div class="answers-title-wrapper">
    <h2 class="text-xl font-bold text-wabi">回答列表</h2>
    <div class="font-controls">
      <button class="font-btn decrease-font" title="縮小字體">
        <i class="fas fa-font"></i>
      </button>
      <button class="font-btn increase-font" title="放大字體">
        <i class="fas fa-font"></i><i class="fas fa-plus" style="font-size: 0.6em; margin-left: -2px;"></i>
      </button>
    </div>
  </div>
  <button id="fullscreenToggle" class="fullscreen-toggle-btn" title="全屏檢視回答">
    <i class="fas fa-expand-arrows-alt"></i>
  </button>
</div>
  </div>
<div id="answersList" class="space-y-5 max-h-[620px] overflow-y-auto pr-2">
<!-- 學生回答將在此顯示 -->
<div class="text-center py-12 text-wabi-secondary">尚未開始</div>
</div>
<div class="mt-8 flex justify-end space-x-5 pt-5 border-t border-stone-gray border-opacity-30">
<button onclick="clearSession()" class="wabi-sabi-button danger px-7 py-3.5 rounded-xl font-medium">
<i class="fas fa-broom mr-2"></i>清空
</button>
<button onclick="endSession()" class="wabi-sabi-button primary px-7 py-3.5 rounded-xl font-medium">
<i class="fas fa-stop mr-2"></i>結束
</button>
</div>
</div>
</div>
</div>
<div class="text-center fade-in" style="animation-delay: 0.2s">
<button onclick="leaveHost()" class="wabi-sabi-button px-9 py-3.5 rounded-xl font-medium text-lg">
<i class="fas fa-door-open mr-2"></i>離開房間
</button>
</div>
</div>
<!-- 學生加入介面 -->
<div id="joinSection" class="hidden space-y-10">
<header class="section-header fade-in-scale">
<h1 class="section-title">
<i class="fas fa-user-graduate text-moss-green mr-3"></i>
加入房間
</h1>
<p class="section-subtitle">請輸入您的姓名與房間代碼</p>
</header>
<div class="max-w-md mx-auto fade-in">
<div class="wabi-sabi-card p-9">
<div class="space-y-7">
<div>
<label class="block text-base font-medium text-wabi-secondary mb-3">您的姓名</label>
<input type="text" id="studentName" class="input-field w-full px-5 py-3.5 rounded-xl" placeholder="請輸入您的姓名">
</div>
<div>
<label class="block text-base font-medium text-wabi-secondary mb-3">房間代碼</label>
<input type="text" id="joinRoomCode" class="input-field w-full px-5 py-3.5 rounded-xl text-center text-2xl tracking-wider font-mono" placeholder="000000" maxlength="6">
</div>
<div class="flex gap-5">
<button onclick="joinAsStudent()" class="wabi-sabi-button primary flex-1 py-4 rounded-xl font-medium text-lg">
<i class="fas fa-door-open mr-2"></i>進入
</button>
<button onclick="showMainMenu()" class="wabi-sabi-button px-6 py-4 rounded-xl">
<i class="fas fa-arrow-left"></i>
</button>
</div>
</div>
</div>
</div>
</div>
<!-- 學生答題介面 -->
<div id="studentSection" class="hidden space-y-10">
<header class="section-header fade-in-scale">
<h1 class="section-title">
<i class="fas fa-user-graduate text-moss-green mr-3"></i>
學生作答
</h1>
<p class="section-subtitle">房間: <span id="studentRoomCode" class="room-code"></span> | 姓名: <span id="studentDisplayName"></span></p>
</header>
<div class="wabi-sabi-card p-9 text-center fade-in">
<div class="question-display mb-8">
<p id="questionDisplay" class="text-xl font-medium text-wabi-secondary">請等待主持人開始計時</p>
</div>
<div class="countdown-display mb-10" id="studentCountdown">01:00</div>
<div id="answerInputArea" class="answer-input-area mb-9">
<textarea id="studentAnswer" class="input-field w-full px-5 py-4 rounded-xl min-h-[160px] text-lg resize-y" placeholder="請在此輸入您的回答..." disabled></textarea>
</div>
<div class="flex justify-center">
<button id="submitBtn" onclick="submitAnswer()" class="wabi-sabi-button primary px-9 py-4.5 rounded-xl font-medium text-lg hidden" disabled>
<i class="fas fa-paper-plane mr-2"></i>提交
</button>
</div>
<div id="submissionStatus" class="mt-7 text-lg font-medium text-wabi-secondary hidden">
<i class="fas fa-check-circle text-moss-green mr-2"></i>已提交回答
</div>
</div>
<div class="text-center fade-in">
<button onclick="leaveStudent()" class="wabi-sabi-button px-9 py-3.5 rounded-xl font-medium text-lg">
<i class="fas fa-door-open mr-2"></i>離開房間
</button>
</div>
</div>
</div>



<script>
// Firebase 配置
const firebaseConfig = {
apiKey: "AIzaSyB17JKsoCf-H66g13EphV9H7GfR3MreFOo",
authDomain: "collect-358e3.firebaseapp.com",
databaseURL: "https://collect-358e3-default-rtdb.firebaseio.com",
projectId: "collect-358e3",
storageBucket: "collect-358e3.firebasestorage.app",
messagingSenderId: "1024060422420",
appId: "1:1024060422420:web:52dd61dff75c7abc44aa01"
};

// 初始化 Firebase
if (!firebase.apps.length) {
firebase.initializeApp(firebaseConfig);
}
const database = firebase.database();

// 顏色主題
const answerColors = [
  { border: '#8a7663', bg: 'rgba(138, 118, 99, 0.08)' }, // 棕色
  { border: '#5f6e55', bg: 'rgba(95, 110, 85, 0.08)' }, // 綠色
  { border: '#a86b6b', bg: 'rgba(168, 107, 107, 0.08)' }, // 紅色
  { border: '#7b8a8a', bg: 'rgba(123, 138, 138, 0.08)' }, // 灰藍色
  { border: '#8a7b65', bg: 'rgba(138, 123, 101, 0.08)' }, // 芥末色
  { border: '#658a7b', bg: 'rgba(101, 138, 123, 0.08)' }, // 藍綠色
  { border: '#8a658a', bg: 'rgba(138, 101, 138, 0.08)' }, // 紫色
  { border: '#8a8a65', bg: 'rgba(138, 138, 101, 0.08)' }  // 橄欖色
];

// 全域變數
let currentRoom = null;
let currentUser = null;
let isHost = false;
let timer = null;
let timeLimit = 60; // 預設60秒 = 1分鐘
let remainingTime = 0;
let roomRef = null;
let sessionActive = false;
let lastQuestionStartTime = null;
let hasSubmitted = false;
let currentQuestionId = null; // 用於追蹤當前問題ID
let editingStudent = null; // 目前正在編輯的學生名稱

// UI 控制函數
function showMainMenu() {
document.getElementById('mainMenu').classList.remove('hidden');
document.getElementById('hostSection').classList.add('hidden');
document.getElementById('joinSection').classList.add('hidden');
document.getElementById('studentSection').classList.add('hidden');
if (roomRef) {
roomRef.off();
roomRef = null;
}
clearInterval(timer);
timer = null;
// 隱藏主持人倒計時
document.getElementById('hostCountdownContainer').classList.add('hidden');
}


function showHostSection() {
document.getElementById('mainMenu').classList.add('hidden');
document.getElementById('hostSection').classList.remove('hidden');
document.getElementById('joinSection').classList.add('hidden');
document.getElementById('studentSection').classList.add('hidden');
// 創建新房間
createRoom();
}

function showJoinSection() {
document.getElementById('mainMenu').classList.add('hidden');
document.getElementById('hostSection').classList.add('hidden');
document.getElementById('joinSection').classList.remove('hidden');
document.getElementById('studentSection').classList.add('hidden');
// 檢查URL參數中是否有房間代碼
const urlParams = new URLSearchParams(window.location.search);
const roomCode = urlParams.get('room');
if (roomCode) {
document.getElementById('joinRoomCode').value = roomCode;
}
}

function showStudentSection() {
document.getElementById('mainMenu').classList.add('hidden');
document.getElementById('hostSection').classList.add('hidden');
document.getElementById('joinSection').classList.add('hidden');
document.getElementById('studentSection').classList.remove('hidden');
// 重置學生提交狀態
hasSubmitted = false;
document.getElementById('submissionStatus').classList.add('hidden');
document.getElementById('answerInputArea').classList.remove('submitted', 'late');
}

// 生成房間代碼
function generateRoomCode() {
return Math.floor(100000 + Math.random() * 900000).toString();
}

// 生成QR CODE
function generateQRCode(roomCode) {
const canvas = document.getElementById('qrCanvas');
const shareUrl = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
QRCode.toCanvas(canvas, shareUrl, {
width: 200,
height: 200,
margin: 2,
color: {
dark: "#383833",
light: "#fdfcf8"
}
}, function (error) {
if (error) {
console.error('QR CODE生成失敗:', error);
alert('QR CODE生成失敗');
}
});
}

// 複製分享連結
function copyShareLink() {
const shareUrl = `${window.location.origin}${window.location.pathname}?room=${currentRoom}`;
const copyBtn = document.getElementById('copyLinkBtn');
navigator.clipboard.writeText(shareUrl).then(() => {
copyBtn.classList.add('copy-success');
copyBtn.innerHTML = '<i class="fas fa-check mr-2"></i>已複製!';
setTimeout(() => {
copyBtn.classList.remove('copy-success');
copyBtn.innerHTML = '<i class="fas fa-copy mr-2"></i>複製分享連結';
}, 3000);
}).catch(err => {
console.error('複製失敗:', err);
prompt('請手動複製以下連結:', shareUrl);
});
}

// 下載QR CODE
function downloadQR() {
const canvas = document.getElementById('qrCanvas');
const link = document.createElement('a');
link.download = `wabi-sabi-room-${currentRoom}-qr.png`;
link.href = canvas.toDataURL();
link.click();
}

// 創建房間
async function createRoom() {
try {
const roomCode = generateRoomCode();
const hostName = "主持人";
const roomData = {
code: roomCode,
host: hostName,
created: firebase.database.ServerValue.TIMESTAMP,
participants: {},
session: {
active: false,
question: "",
questionId: Date.now(), // 新增問題ID
timeLimit: 60, // 預設60秒
startTime: null,
endTime: null
},
answers: {}
};
await database.ref('class_rooms/' + roomCode).set(roomData);
currentRoom = roomCode;
currentUser = hostName;
isHost = true;
currentQuestionId = roomData.session.questionId;
document.getElementById('hostRoomCode').textContent = roomCode;
generateQRCode(roomCode);
// 設置房間監聽器
setupRoomListener();
} catch (error) {
console.error('創建房間失敗:', error);
alert('創建房間失敗,請重試');
}
}

// 加入房間作為學生
async function joinAsStudent() {
const studentName = document.getElementById('studentName').value.trim();
const roomCode = document.getElementById('joinRoomCode').value.trim();
if (!studentName || !roomCode) {
alert('請輸入姓名和房間代碼');
return;
}
if (roomCode.length !== 6) {
alert('房間代碼必須是6位數');
return;
}
try {
const roomSnapshot = await database.ref('class_rooms/' + roomCode).once('value');
if (!roomSnapshot.exists()) {
alert('房間不存在');
return;
}
const roomData = roomSnapshot.val();
// 檢查是否已有同名學生
if (roomData.participants && roomData.participants[studentName]) {
alert('此名稱已被使用,請選擇其他名稱');
return;
}
// 加入房間
await database.ref('class_rooms/' + roomCode + '/participants/' + studentName).set({
name: studentName,
joined: firebase.database.ServerValue.TIMESTAMP,
submitted: false,
late: false,
lastQuestionId: roomData.session.questionId || null
});
currentRoom = roomCode;
currentUser = studentName;
isHost = false;
document.getElementById('studentRoomCode').textContent = roomCode;
document.getElementById('studentDisplayName').textContent = studentName;
// 設置房間監聽器
setupRoomListener();
// 顯示學生介面
showStudentSection();
} catch (error) {
console.error('加入房間失敗:', error);
alert('加入房間失敗,請重試');
}
}

// 設置房間監聽器
function setupRoomListener() {
  if (roomRef) {
    roomRef.off();
  }
  roomRef = database.ref('class_rooms/' + currentRoom);
  
  // 使用更短的防抖時間 + 智能更新
  let updateTimeout = null;
  let lastUpdateTime = 0;
  const MIN_UPDATE_INTERVAL = 300; // 最小更新間隔300ms
  
  roomRef.on('value', (snapshot) => {
    if (!snapshot.exists()) {
      alert('房間已不存在');
      showMainMenu();
      return;
    }
    
    const roomData = snapshot.val();
    const currentTime = Date.now();
    
    // 如果是重要更新（如計時器狀態變化），立即更新
    const isCriticalUpdate = 
      roomData.session?.active !== sessionActive ||
      !roomData.session?.active; // 計時器停止也立即更新
    
    if (isCriticalUpdate || (currentTime - lastUpdateTime) > MIN_UPDATE_INTERVAL) {
      // 立即更新
      clearTimeout(updateTimeout);
      performUIUpdate(roomData);
      lastUpdateTime = currentTime;
    } else {
      // 非關鍵更新，使用短防抖
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(() => {
        performUIUpdate(roomData);
        lastUpdateTime = Date.now();
      }, 50); // 僅50ms防抖，幾乎無感
    }
  });
}

// 統一的UI更新函數
function performUIUpdate(roomData) {
  // 更新參與者數量
  updateParticipantCount(roomData.participants);
  
  if (isHost) {
    // 更新主持人介面
    updateHostUI(roomData);
  } else {
    // 更新學生介面
    updateStudentUI(roomData);
  }
}


let currentFontSize = 1.5; // 預設字體大小 24px

function initializeFontControls() {
  // 綁定字體控制按鈕事件
  document.querySelectorAll('.increase-font').forEach(btn => {
    btn.addEventListener('click', increaseFontSize);
  });
  
  document.querySelectorAll('.decrease-font').forEach(btn => {
    btn.addEventListener('click', decreaseFontSize);
  });
  
  // 應用預設字體大小
  applyFontSize();
}

function increaseFontSize() {
  currentFontSize = Math.min(3.0, currentFontSize + 0.3); // 上限 48px
  applyFontSize();
}

function decreaseFontSize() {
  currentFontSize = Math.max(1.2, currentFontSize - 0.3); // 下限 19px
  applyFontSize();
}

function applyFontSize() {
  // 應用於普通模式的回答內容
  document.querySelectorAll('.answer-display').forEach(element => {
    element.style.fontSize = `${currentFontSize}rem`;
    element.style.lineHeight = '1.8'; // 確保行距
  });
 
  // 應用於全屏模式的回答內容
  document.querySelectorAll('#fullscreenAnswers .answer-display').forEach(element => {
    element.style.fontSize = `${currentFontSize * 1.2}rem`;
    element.style.lineHeight = '1.8';
  });
 
  // 保存到 localStorage
  localStorage.setItem('answerFontSize', currentFontSize);
}

// 在頁面加載時初始化字體控制
document.addEventListener('DOMContentLoaded', () => {
  // 從 localStorage 讀取保存的字體大小
  const savedFontSize = localStorage.getItem('answerFontSize');
  if (savedFontSize) {
    currentFontSize = parseFloat(savedFontSize);
  }
  
  initializeFontControls();
  
  // 確保在生成回答列表後應用字體大小
  setTimeout(applyFontSize, 100);
});


// 修改全屏回答生成函數
function generateFullscreenAnswersHTML(answers, participants) {
  // 現有代碼保持不變，但確保回答內容有正確的字體大小
  const answersArray = Object.entries(answers)
    .map(([name, answerData]) => ({
      name,
      ...answerData
    }))
    .sort((a, b) => a.timestamp - b.timestamp);

  let html = '';
  
  answersArray.forEach((answer, index) => {
    const participant = participants[answer.name] || {};
    const isLate = participant.late || false;
    const studentColor = getStudentColor(answer.name);
    
    const timestamp = new Date(answer.timestamp);
    const timeString = timestamp.toLocaleTimeString([], {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
    
    const editableText = answer.text.replace(/<br>/g, '\n');
    
    html += `
      <div class="fullscreen-answer-card student-card p-6 rounded-xl ${isLate ? 'late' : 'answered'} fade-in" 
           data-student="${answer.name}"
           style="border-color: ${studentColor.border}; background-color: ${studentColor.bg};">
        <div class="editing-indicator">
          <i class="fas fa-edit mr-1"></i>編輯中
        </div>
        <div class="flex justify-between items-start mb-4">
          <div class="font-medium text-xl flex items-center">
            ${isLate ? '<i class="fas fa-clock text-red-500 mr-2 text-xl"></i>' : '<i class="fas fa-check-circle text-moss-green mr-2 text-xl"></i>'}
            <span class="student-name-tag text-lg px-4 py-2" style="background-color: ${studentColor.border}15; color: ${studentColor.border};">${answer.name}</span>
          </div>
          <div class="text-base text-wabi-secondary bg-earth-beige px-4 py-2 rounded-full font-medium">
            ${timeString} ${isLate ? '(超時)' : ''}
          </div>
        </div>
        
        <div class="answer-display mt-4 text-left text-xl" 
             data-student="${answer.name}" 
             contenteditable="false"
             spellcheck="false"
             style="font-size: ${currentFontSize * 1.2}rem;">
          ${editableText}
        </div>
        
        <div class="save-status text-sm text-wabi-secondary mt-3 text-right hidden">
          <i class="fas fa-save mr-1"></i>已自動保存
        </div>
      </div>
    `;
  });
  
  return html;
}

    

// 更新參與者數量 - 優化版本
function updateParticipantCount(participants) {
  const countElement = document.getElementById('participantCount');
  if (!countElement) return;
  
  const newCount = participants ? Object.values(participants).length : 0;
  const currentCount = parseInt(countElement.textContent) || 0;
  
  // 只有數量變化時才更新
  if (newCount !== currentCount) {
    countElement.textContent = newCount;
    updateParticipantsStatus(participants);
  }
}

// 更新參與者狀態 - 優化版本
function updateParticipantsStatus(participants) {
  const statusElement = document.getElementById('participantsStatus');
  if (!statusElement) return;
  
  // 檢查是否需要更新
  const currentHTML = statusElement.innerHTML;
  const shouldUpdate = shouldUpdateParticipants(participants, currentHTML);
  
  if (!shouldUpdate) return;
  
  // 執行更新
  if (!participants || Object.keys(participants).length === 0) {
    statusElement.innerHTML = '<div class="text-center py-10 text-wabi-secondary">尚未有人加入</div>';
    return;
  }
  
  const participantArray = Object.values(participants);
  participantArray.sort((a, b) => (a.joined || 0) - (b.joined || 0));
  
  let newHTML = '';
  participantArray.forEach(participant => {
    const statusText = participant.submitted ?
      (participant.late ? '<span class="text-red-600 font-medium">已提交(超時)</span>' : 
                          '<span class="text-moss-green font-medium">已提交</span>') :
      '<span class="text-stone-gray font-medium">未提交</span>';
    
    newHTML += `
      <div class="flex items-center justify-between p-3.5 rounded-xl bg-earth-beige bg-opacity-40 hover:shadow-md transition-shadow">
        <div class="flex items-center">
          <i class="fas fa-user text-clay-brown mr-3 text-lg"></i>
          <span class="font-medium text-base">${participant.name}</span>
        </div>
        <div class="font-medium">${statusText}</div>
      </div>
    `;
  });
  
  statusElement.innerHTML = newHTML;
}

// 檢查參與者列表是否需要更新
function shouldUpdateParticipants(participants, currentHTML) {
  if (!participants || Object.keys(participants).length === 0) {
    return currentHTML.includes('尚未有人加入');
  }
  
  // 簡單檢查：如果數量不匹配，需要更新
  const participantCount = Object.keys(participants).length;
  const currentItemCount = (currentHTML.match(/flex items-center justify-between/g) || []).length;
  
  return participantCount !== currentItemCount;
}

    

// 更新學生狀態
function updateStudentUI(roomData) {
const questionDisplay = document.getElementById('questionDisplay');
const countdownDisplay = document.getElementById('studentCountdown');
const answerInput = document.getElementById('studentAnswer');
const submitBtn = document.getElementById('submitBtn');
const submissionStatus = document.getElementById('submissionStatus');
const answerInputArea = document.getElementById('answerInputArea');

// 檢查是否是新問題
const participant = roomData.participants?.[currentUser] || {};
const isNewQuestion = roomData.session.questionId !== participant.lastQuestionId;

// 如果是新問題,重置提交狀態
if (isNewQuestion) {
hasSubmitted = false;
submissionStatus.classList.add('hidden');
answerInputArea.classList.remove('submitted', 'late');
answerInput.disabled = false;
answerInput.value = '';
document.getElementById('studentAnswer').value = '';
}

if (roomData.session.active) {
// 顯示問題
questionDisplay.textContent = roomData.session.question || '請輸入您的回答';
questionDisplay.classList.remove('text-wabi-secondary');
questionDisplay.classList.add('text-charcoal');

// 啟動本地計時器
if (roomData.session.startTime && !timer) {
startLocalTimer(roomData.session.startTime, roomData.session.timeLimit);
}

// 檢查學生是否已提交
if (participant.submitted && !isNewQuestion) {
hasSubmitted = true;
submissionStatus.classList.remove('hidden');
answerInput.disabled = true;
submitBtn.classList.add('hidden');
answerInputArea.classList.add('submitted');
if (participant.late) {
answerInputArea.classList.add('late');
}
} else if (remainingTime > 0 && !hasSubmitted) {
// 還可以回答
answerInput.disabled = false;
submitBtn.classList.remove('hidden');
submitBtn.disabled = false;
} else if (!hasSubmitted) {
// 時間已到,禁止提交
answerInput.disabled = true;
submitBtn.classList.add('hidden');
submitBtn.disabled = true;
answerInput.placeholder = '時間已到,無法提交';
}
} else {
// 未開始
questionDisplay.textContent = '請等待主持人開始計時';
questionDisplay.classList.add('text-wabi-secondary');
questionDisplay.classList.remove('text-charcoal');
countdownDisplay.textContent = '00:00';
answerInput.disabled = true;
submitBtn.classList.add('hidden');
submitBtn.disabled = true;
answerInput.placeholder = '請等待主持人開始計時';
clearInterval(timer);
timer = null;
}
}

// 啟動本地計時器
function startLocalTimer(startTime, totalTime) {
  // 先清除所有現有計時器
  clearInterval(timer);
  
  lastQuestionStartTime = startTime;
  remainingTime = totalTime;
  
  timer = setInterval(() => {
    const currentTime = Date.now();
    const elapsed = Math.floor((currentTime - startTime) / 1000);
    remainingTime = Math.max(0, totalTime - elapsed);
    
    // 更新倒計時顯示
    updateCountdownDisplay(remainingTime);
    
    // 時間到了,禁止學生提交
    if (remainingTime <= 0) {
      clearInterval(timer);
      timer = null;
      // 如果是學生端且尚未提交,則禁用提交按鈕
      if (!isHost && !hasSubmitted) {
        const submitBtn = document.getElementById('submitBtn');
        const answerInput = document.getElementById('studentAnswer');
        if (submitBtn) {
          submitBtn.classList.add('hidden');
          submitBtn.disabled = true;
        }
        if (answerInput) {
          answerInput.disabled = true;
          answerInput.placeholder = '時間已到,無法提交';
        }
      }
    }
  }, 1000);
  
  // 立即更新一次顯示
  updateCountdownDisplay(remainingTime);
}

// 格式化並更新倒數計時顯示
function updateCountdownDisplay(seconds) {
const minutes = Math.floor(seconds / 60);
const secs = seconds % 60;
const formattedTime = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

// 更新學生介面
const studentCountdown = document.getElementById('studentCountdown');
if (studentCountdown) {
studentCountdown.textContent = formattedTime;
// 依剩餘時間改變顏色
if (seconds <= 5) {
studentCountdown.style.color = '#a86b6b';
studentCountdown.classList.add('pulse');
} else if (seconds <= 10) {
studentCountdown.style.color = '#8a7663';
studentCountdown.classList.remove('pulse');
} else {
studentCountdown.style.color = '#383833';
studentCountdown.classList.remove('pulse');
}
}

// 更新主持人介面
const hostCountdownDisplay = document.getElementById('hostCountdownDisplay');
if (hostCountdownDisplay) {
hostCountdownDisplay.textContent = formattedTime;
if (seconds <= 5) {
hostCountdownDisplay.style.color = '#a86b6b';
hostCountdownDisplay.classList.add('pulse');
} else if (seconds <= 10) {
hostCountdownDisplay.style.color = '#8a7663';
hostCountdownDisplay.classList.remove('pulse');
} else {
hostCountdownDisplay.style.color = '#383833';
hostCountdownDisplay.classList.remove('pulse');
}
}
}

// 更新主持人介面
function updateHostUI(roomData) {
  // 更新剩餘時間
  if (roomData.session.active && roomData.session.startTime) {
    // 如果計時器尚未啟動,則啟動本地計時器
    if (!timer) {
      startLocalTimer(roomData.session.startTime, roomData.session.timeLimit);
    }
    
    // 顯示主持人倒計時
    document.getElementById('hostCountdownContainer').classList.remove('hidden');
    
    // 更新按鈕狀態
    document.getElementById('startBtn').innerHTML = '<i class="fas fa-pause mr-2"></i>暫停';
  } else {
    // 停止計時器
    clearInterval(timer);
    timer = null;
    remainingTime = timeLimit;
    updateCountdownDisplay(remainingTime);
    document.getElementById('startBtn').innerHTML = '<i class="fas fa-play mr-2"></i>開始';
    
    // 隱藏主持人倒計時
    document.getElementById('hostCountdownContainer').classList.add('hidden');
  }
  
  // 更新回答列表
  updateAnswersList(roomData.answers, roomData.participants);
}

// 取得學生的顏色
function getStudentColor(studentName) {
// 使用學生名稱的哈希值來選擇一個顏色
let hash = 0;
for (let i = 0; i < studentName.length; i++) {
hash = studentName.charCodeAt(i) + ((hash << 5) - hash);
}
const index = Math.abs(hash) % answerColors.length;
return answerColors[index];
}



// 判斷是否可以使用增量更新
function shouldUseIncrementalUpdate(container, newAnswers) {
  const existingAnswers = container.querySelectorAll('.student-card');
  const newAnswerCount = newAnswers ? Object.keys(newAnswers).length : 0;
  
  // 如果只是新增了一個答案，使用增量更新
  return existingAnswers.length > 0 && 
         newAnswerCount === existingAnswers.length + 1;
}

// 增量更新 - 只添加新答案
function performIncrementalUpdate(container, answers, participants) {
  const answersArray = Object.entries(answers)
    .map(([name, answerData]) => ({ name, ...answerData }))
    .sort((a, b) => a.timestamp - b.timestamp);
  
  // 找到最新的答案（最後一個）
  const latestAnswer = answersArray[answersArray.length - 1];
  const participant = participants[latestAnswer.name] || {};
  
  // 創建並添加新答案卡片
  const newCard = createAnswerCard(latestAnswer, participant);
  container.appendChild(newCard);
  
  // 設置編輯功能（如果是主持人）
  if (isHost) {
    setupDoubleClickEditing(newCard, latestAnswer.name);
  }
  
  // 確保全屏按鈕存在
  ensureFullscreenButton(container, answers, participants);
}

// 完全更新
function performFullUpdate(container, answers, participants) {
  container.innerHTML = '';
  
 
  
  if (!sessionActive) {
    container.innerHTML += '<div class="text-center py-12 text-wabi-secondary">尚未開始</div>';
    return;
  }
  
  if (!answers || Object.keys(answers).length === 0) {
    container.innerHTML += '<div class="text-center py-12 text-wabi-secondary">尚未有回答</div>';
    return;
  }

  // 將答案轉換為陣列並排序
  const answersArray = Object.entries(answers)
    .map(([name, answerData]) => ({ name, ...answerData }))
    .sort((a, b) => a.timestamp - b.timestamp);

  answersArray.forEach((answer) => {
    const participant = participants[answer.name] || {};
    const card = createAnswerCard(answer, participant);
    container.appendChild(card);
    
    // 只有主持人才能編輯
    if (isHost) {
      setupDoubleClickEditing(card, answer.name);
    }
  });
}

// 創建答案卡片的輔助函數
function createAnswerCard(answer, participant) {
  const isLate = participant.late || false;
  const studentColor = getStudentColor(answer.name);
  
  const div = document.createElement('div');
  div.className = `student-card p-5 rounded-xl ${isLate ? 'late' : 'answered'} fade-in`;
  div.style.borderColor = studentColor.border;
  div.style.backgroundColor = studentColor.bg;

  const timestamp = new Date(answer.timestamp);
  const timeString = timestamp.toLocaleTimeString([], {
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  });

  // 將 Firebase 中的文本轉換回可編輯格式
  const editableText = answer.text.replace(/<br>/g, '\n');
  
  div.innerHTML = `
    <div class="editing-indicator">
      <i class="fas fa-edit mr-1"></i>編輯中
    </div>
    <div class="flex justify-between items-start mb-3">
      <div class="font-medium text-lg flex items-center">
        ${isLate ? '<i class="fas fa-clock text-red-500 mr-2 text-lg"></i>' : '<i class="fas fa-check-circle text-moss-green mr-2 text-lg"></i>'}
        <span class="student-name-tag" style="background-color: ${studentColor.border}15; color: ${studentColor.border};">${answer.name}</span>
      </div>
      <div class="text-sm text-wabi-secondary bg-earth-beige px-3.5 py-1.5 rounded-full font-medium">
        ${timeString} ${isLate ? '(超時)' : ''}
      </div>
    </div>
    
    <div class="answer-display mt-3 text-left text-base" 
         data-student="${answer.name}" 
         contenteditable="false"
         spellcheck="false">
      ${editableText}
    </div>
    
    <div class="save-status text-xs text-wabi-secondary mt-2 text-right hidden">
      <i class="fas fa-save mr-1"></i>已自動保存
    </div>
  `;
  
  return div;
}

// 確保全屏按鈕存在
function ensureFullscreenButton(container, answers, participants) {
  // 如果已經有全屏按鈕，不需要重複添加
  if (container.querySelector('.fullscreen-toggle-btn')) {
    return;
  }
  
  // 添加全屏按鈕
  if (isHost && answers && Object.keys(answers).length > 0) {
    const fullscreenBtn = document.createElement('button');
    fullscreenBtn.className = 'fullscreen-toggle-btn';
    fullscreenBtn.innerHTML = '<i class="fas fa-expand-arrows-alt"></i>';
    fullscreenBtn.title = '全屏檢視回答';
    fullscreenBtn.addEventListener('click', () => {
      openFullscreenAnswers(answers, participants);
    });
    container.insertBefore(fullscreenBtn, container.firstChild);
  }
}


    // 設置雙擊編輯功能
function setupDoubleClickEditing(cardElement, studentName) {
  const answerElement = cardElement.querySelector('.answer-display');
  const saveStatus = cardElement.querySelector('.save-status');
  const editingIndicator = cardElement.querySelector('.editing-indicator');
  
  let originalText = answerElement.textContent;
  let saveTimeout = null;
  let isEditing = false;
  
  // 開始編輯
  function startEditing() {
    isEditing = true;
    cardElement.classList.add('editing');
    originalText = answerElement.textContent;
    answerElement.contentEditable = "true";
    answerElement.focus();
    
    // 將游標移動到內容末尾
    const range = document.createRange();
    range.selectNodeContents(answerElement);
    range.collapse(false);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
  }
  
  // 結束編輯
  function endEditing() {
    isEditing = false;
    cardElement.classList.remove('editing');
    answerElement.contentEditable = "false";
    
    // 確保保存
    autoSave();
  }
  
  // 自動保存
  function autoSave() {
    if (!isEditing) return;
    
    const currentText = answerElement.textContent.trim();
    
    // 如果文本沒有變化，不保存
    if (currentText === originalText) return;
    
    // 清除之前的定時器
    if (saveTimeout) {
      clearTimeout(saveTimeout);
    }
    
    // 設置新的定時器（防抖）
    saveTimeout = setTimeout(async () => {
      try {
        // 更新 Firebase 中的答案
        await database.ref(`class_rooms/${currentRoom}/answers/${studentName}`).update({
          text: currentText.replace(/\n/g, '<br>')
        });
        
        // 顯示保存狀態
        saveStatus.classList.remove('hidden');
        setTimeout(() => {
          saveStatus.classList.add('hidden');
        }, 2000);
        
        // 更新原始文本
        originalText = currentText;
        
      } catch (error) {
        console.error('自動保存失敗:', error);
      }
    }, 1000); // 1秒後自動保存
  }
  
  // 事件監聽器
  
  // 雙擊開始編輯
  answerElement.addEventListener('dblclick', () => {
    if (isHost && !isEditing) {
      startEditing();
    }
  });
  
  // 失去焦點時結束編輯
  answerElement.addEventListener('blur', () => {
    if (isEditing) {
      endEditing();
    }
  });
  
  // 輸入時自動保存
  answerElement.addEventListener('input', autoSave);
  
  // 按 Ctrl+S 手動保存
  answerElement.addEventListener('keydown', (e) => {
    if (e.key === 's' && e.ctrlKey) {
      e.preventDefault();
      autoSave();
      
      // 顯示手動保存提示
      saveStatus.innerHTML = '<i class="fas fa-save mr-1"></i>已手動保存';
      saveStatus.classList.remove('hidden');
      setTimeout(() => {
        saveStatus.classList.add('hidden');
      }, 2000);
    } else if (e.key === 'Escape') {
      // 按 Escape 取消編輯
      answerElement.textContent = originalText;
      endEditing();
    }
  });
  
  // 添加提示
  answerElement.title = '雙擊編輯答案，自動保存。按 Ctrl+S 手動保存，按 Escape 取消。';
}


// 全屏回答列表功能
function setupFullscreenAnswers() {
  const fullscreenContainer = document.getElementById('fullscreenAnswers');
  const closeBtn = document.getElementById('closeFullscreen');
  const answersList = document.getElementById('fullscreenAnswersList');
  
  // 關閉全屏
  closeBtn.addEventListener('click', closeFullscreenAnswers);
  
  // ESC 鍵關閉全屏
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !fullscreenContainer.classList.contains('hidden')) {
      closeFullscreenAnswers();
    }
  });
}

// 開啟全屏回答列表
function openFullscreenAnswers(answers, participants) {
  const fullscreenContainer = document.getElementById('fullscreenAnswers');
  const answersList = document.getElementById('fullscreenAnswersList');
  
  // 隱藏主介面
  document.getElementById('hostSection').classList.add('hidden');
  
  if (!answers || Object.keys(answers).length === 0) {
    answersList.innerHTML = '<div class="text-center py-20 text-wabi-secondary text-xl">尚未有回答</div>';
  } else {
    // 生成全屏回答列表
    answersList.innerHTML = generateFullscreenAnswersHTML(answers, participants);
    
    // 為每個回答卡片設置編輯功能
    setupFullscreenEditing(answers, participants);
  }
  
  // 顯示全屏容器
  fullscreenContainer.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

// 關閉全屏回答列表
function closeFullscreenAnswers() {
  const fullscreenContainer = document.getElementById('fullscreenAnswers');
  fullscreenContainer.classList.add('hidden');
  document.body.style.overflow = '';
  
  // 重新顯示主介面
  document.getElementById('hostSection').classList.remove('hidden');
}

// 修改 generateFullscreenAnswersHTML 函數
function generateFullscreenAnswersHTML(answers, participants) {
  const answersArray = Object.entries(answers)
    .map(([name, answerData]) => ({
      name,
      ...answerData
    }))
    .sort((a, b) => a.timestamp - b.timestamp);

  let html = '';
  
  answersArray.forEach((answer, index) => {
    const participant = participants[answer.name] || {};
    const isLate = participant.late || false;
    const studentColor = getStudentColor(answer.name);
    
    const timestamp = new Date(answer.timestamp);
    const timeString = timestamp.toLocaleTimeString([], {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
    
    // 將 Firebase 中的文本轉換回可編輯格式
    const editableText = answer.text.replace(/<br>/g, '\n');
    
    html += `
      <div class="fullscreen-answer-card student-card p-6 rounded-xl ${isLate ? 'late' : 'answered'} fade-in" 
           data-student="${answer.name}"
           style="border-color: ${studentColor.border}; background-color: ${studentColor.bg};">
        <div class="editing-indicator">
          <i class="fas fa-edit mr-1"></i>編輯中
        </div>
        <div class="flex justify-between items-start mb-4">
          <div class="font-medium text-xl flex items-center">
            ${isLate ? '<i class="fas fa-clock text-red-500 mr-2 text-xl"></i>' : '<i class="fas fa-check-circle text-moss-green mr-2 text-xl"></i>'}
            <span class="student-name-tag text-lg px-4 py-2" style="background-color: ${studentColor.border}15; color: ${studentColor.border};">${answer.name}</span>
          </div>
          <div class="text-base text-wabi-secondary bg-earth-beige px-4 py-2 rounded-full font-medium">
            ${timeString} ${isLate ? '(超時)' : ''}
          </div>
        </div>
        
        <!-- 使用與普通模式相同的可編輯區域 -->
        <div class="answer-display mt-4 text-left text-xl" 
             data-student="${answer.name}" 
             contenteditable="false"
             spellcheck="false">
          ${editableText}
        </div>
        
        <div class="save-status text-sm text-wabi-secondary mt-3 text-right hidden">
          <i class="fas fa-save mr-1"></i>已自動保存
        </div>
      </div>
    `;
  });
  
  return html;
}

// 修改 setupFullscreenEditing 函數
function setupFullscreenEditing(answers, participants) {
  const answerCards = document.querySelectorAll('.fullscreen-answer-card');
  
  answerCards.forEach(card => {
    const studentName = card.getAttribute('data-student');
    
    // 使用與普通模式相同的雙擊編輯功能
    setupDoubleClickEditing(card, studentName);
    
    // 移除原來的編輯按鈕和相關邏輯，因為我們現在使用雙擊編輯
  });
}

// 修改 updateAnswersList 函數，添加全屏按鈕
// 修改 updateAnswersList 函數中的全屏按鈕部分
function updateAnswersList(answers, participants) {
  const answersList = document.getElementById('answersList');
  
  // 檢查數據是否真的變化
  const currentAnswers = JSON.stringify(answers || {});
  const lastAnswers = answersList.getAttribute('data-last-answers') || '{}';
  
  if (currentAnswers === lastAnswers) {
    return; // 數據沒有變化，不更新
  }
  
  // 保存當前狀態
  answersList.setAttribute('data-last-answers', currentAnswers);
  
  answersList.innerHTML = '';
  

  if (!sessionActive) {
    answersList.innerHTML += '<div class="text-center py-12 text-wabi-secondary">尚未開始</div>';
    return;
  }
  
  if (!answers || Object.keys(answers).length === 0) {
    answersList.innerHTML += '<div class="text-center py-12 text-wabi-secondary">尚未有回答</div>';
    return;
  }
  
  if (!answers || Object.keys(answers).length === 0) {
    answersList.innerHTML += '<div class="text-center py-12 text-wabi-secondary">尚未有回答</div>';
    return;
  }

  // 將答案轉換為陣列並排序(先顯示早提交的答案)
  const answersArray = Object.entries(answers)
    .map(([name, answerData]) => ({
      name,
      ...answerData
    }))
    .sort((a, b) => a.timestamp - b.timestamp);

  answersArray.forEach((answer, index) => {
    const participant = participants[answer.name] || {};
    const isLate = participant.late || false;
    const studentColor = getStudentColor(answer.name);
    
    const div = document.createElement('div');
    div.className = `student-card p-5 rounded-xl ${isLate ? 'late' : 'answered'} fade-in`;
    div.style.borderColor = studentColor.border;
    div.style.backgroundColor = studentColor.bg;

    const timestamp = new Date(answer.timestamp);
    const timeString = timestamp.toLocaleTimeString([], {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });

    // 將 Firebase 中的文本轉換回可編輯格式（將 <br> 轉回換行）
    const editableText = answer.text.replace(/<br>/g, '\n');
    
    div.innerHTML = `
      <div class="editing-indicator">
        <i class="fas fa-edit mr-1"></i>編輯中
      </div>
      <div class="flex justify-between items-start mb-3">
        <div class="font-medium text-lg flex items-center">
          ${isLate ? '<i class="fas fa-clock text-red-500 mr-2 text-lg"></i>' : '<i class="fas fa-check-circle text-moss-green mr-2 text-lg"></i>'}
          <span class="student-name-tag" style="background-color: ${studentColor.border}15; color: ${studentColor.border};">${answer.name}</span>
        </div>
        <div class="text-sm text-wabi-secondary bg-earth-beige px-3.5 py-1.5 rounded-full font-medium">
          ${timeString} ${isLate ? '(超時)' : ''}
        </div>
      </div>
      
      <!-- 直接可編輯的答案區域 - 初始不可編輯 -->
      <div class="answer-display mt-3 text-left text-base" 
           data-student="${answer.name}" 
           contenteditable="false"
           spellcheck="false">
        ${editableText}
      </div>
      
      <!-- 自動保存提示 -->
      <div class="save-status text-xs text-wabi-secondary mt-2 text-right hidden">
        <i class="fas fa-save mr-1"></i>已自動保存
      </div>
    `;
    
    answersList.appendChild(div);
    
    // 只有主持人才能編輯
    if (isHost) {
      setupDoubleClickEditing(div, answer.name);
    }
  });
}

    

    // 設置直接編輯功能
function setupDirectEditing(cardElement, studentName) {
  const answerElement = cardElement.querySelector('.answer-display');
  const saveStatus = cardElement.querySelector('.save-status');
  const editingIndicator = cardElement.querySelector('.editing-indicator');
  
  let originalText = answerElement.textContent;
  let saveTimeout = null;
  let isEditing = false;
  
  // 開始編輯
  function startEditing() {
    isEditing = true;
    cardElement.classList.add('editing');
    originalText = answerElement.textContent;
  }
  
  // 結束編輯
  function endEditing() {
    isEditing = false;
    cardElement.classList.remove('editing');
  }
  
  // 自動保存
  function autoSave() {
    if (!isEditing) return;
    
    const currentText = answerElement.textContent.trim();
    
    // 如果文本沒有變化，不保存
    if (currentText === originalText) return;
    
    // 清除之前的定時器
    if (saveTimeout) {
      clearTimeout(saveTimeout);
    }
    
    // 設置新的定時器（防抖）
    saveTimeout = setTimeout(async () => {
      try {
        // 更新 Firebase 中的答案
        await database.ref(`class_rooms/${currentRoom}/answers/${studentName}`).update({
          text: currentText.replace(/\n/g, '<br>')
        });
        
        // 顯示保存狀態
        saveStatus.classList.remove('hidden');
        setTimeout(() => {
          saveStatus.classList.add('hidden');
        }, 2000);
        
        // 更新原始文本
        originalText = currentText;
        
      } catch (error) {
        console.error('自動保存失敗:', error);
        // 可以考慮在這裡添加錯誤提示
      }
    }, 1000); // 1秒後自動保存
  }
  
  // 事件監聽器
  
  // 聚焦時開始編輯
  answerElement.addEventListener('focus', () => {
    startEditing();
  });
  
  // 失去焦點時結束編輯
  answerElement.addEventListener('blur', () => {
    // 確保最後一次更改被保存
    autoSave();
    setTimeout(() => {
      endEditing();
    }, 100);
  });
  
  // 輸入時自動保存
  answerElement.addEventListener('input', autoSave);
  
  // 按 Ctrl+S 手動保存
  answerElement.addEventListener('keydown', (e) => {
    if (e.key === 's' && e.ctrlKey) {
      e.preventDefault();
      autoSave();
      
      // 顯示手動保存提示
      saveStatus.innerHTML = '<i class="fas fa-save mr-1"></i>已手動保存';
      saveStatus.classList.remove('hidden');
      setTimeout(() => {
        saveStatus.classList.add('hidden');
      }, 2000);
    }
  });
  
  // 添加提示
  answerElement.title = '直接編輯答案，自動保存。按 Ctrl+S 手動保存。';
}

// 設置內聯編輯功能
function setupInlineEditing(cardElement, studentName) {
  const displayElement = cardElement.querySelector('.answer-display');
  const editContainer = cardElement.querySelector('.edit-container');
  const editorElement = cardElement.querySelector('.answer-editor');
  const saveBtn = cardElement.querySelector('.save-answer-btn');
  const cancelBtn = cardElement.querySelector('.cancel-edit-btn');
  
  let originalText = editorElement.value;
  
  // 開始編輯
  function startEditing() {
    // 隱藏顯示區域
    displayElement.classList.add('hidden');
    
    // 顯示編輯區域
    editContainer.classList.remove('hidden');
    
    // 聚焦到編輯器並選擇所有文本
    editorElement.focus();
    editorElement.select();
    
    // 標記卡片為編輯狀態
    cardElement.classList.add('editing');
  }
  
  // 結束編輯
  function endEditing() {
    // 顯示顯示區域
    displayElement.classList.remove('hidden');
    
    // 隱藏編輯區域
    editContainer.classList.add('hidden');
    
    // 移除編輯狀態
    cardElement.classList.remove('editing');
  }
  
  // 保存編輯
  async function saveEditing() {
    const editedText = editorElement.value.trim();
    
    if (!editedText) {
      alert('答案內容不能為空');
      editorElement.focus();
      return;
    }
    
    try {
      // 更新 Firebase 中的答案
      await database.ref(`class_rooms/${currentRoom}/answers/${studentName}`).update({
        text: editedText
      });
      
      // 更新顯示區域的內容（將換行轉為 <br>）
      displayElement.innerHTML = editedText.replace(/\n/g, '<br>');
      
      // 結束編輯模式
      endEditing();
      
      // 顯示成功訊息
      showSuccessMessage('答案已成功更新');
    } catch (error) {
      console.error('更新答案失敗:', error);
      alert('更新答案失敗,請重試');
    }
  }
  
  // 取消編輯
  function cancelEditing() {
    // 恢復原始文本
    editorElement.value = originalText;
    endEditing();
  }
  
  // 事件監聽器
  saveBtn.addEventListener('click', saveEditing);
  
  cancelBtn.addEventListener('click', cancelEditing);
  
  // 按 Enter + Ctrl 保存
  editorElement.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.ctrlKey) {
      e.preventDefault();
      saveEditing();
    } else if (e.key === 'Escape') {
      cancelEditing();
    }
  });
  
  // 雙擊顯示區域開始編輯
  displayElement.addEventListener('dblclick', () => {
    if (isHost) {
      startEditing();
    }
  });
  
  // 添加視覺提示，讓用戶知道可以雙擊編輯
  displayElement.style.cursor = 'text';
  displayElement.title = '雙擊編輯答案';
}

// 保存編輯的答案
async function saveEditedAnswer(studentName, editedText) {
  if (!studentName || !currentRoom) return;
  
  // 將換行符轉換回 <br> 用於顯示
  const formattedText = editedText.replace(/\n/g, '<br>');
  
  try {
    // 更新 Firebase 中的答案
    await database.ref(`class_rooms/${currentRoom}/answers/${studentName}`).update({
      text: formattedText
    });
    
    // 顯示成功訊息
    showSuccessMessage('答案已成功更新');
  } catch (error) {
    console.error('更新答案失敗:', error);
    alert('更新答案失敗,請重試');
  }
}

// 顯示成功訊息
function showSuccessMessage(message) {
  const successMessage = document.createElement('div');
  successMessage.className = 'fixed top-4 right-4 bg-moss-green text-white px-6 py-3 rounded-xl shadow-lg z-1000 fade-in';
  successMessage.innerHTML = `<i class="fas fa-check mr-2"></i>${message}`;
  document.body.appendChild(successMessage);
  
  // 3秒後移除成功訊息
  setTimeout(() => {
    if (document.body.contains(successMessage)) {
      document.body.removeChild(successMessage);
    }
  }, 3000);
}





// 開始/暫停計時
async function startSession() {
  if (!isHost || !currentRoom) return;
  
  const question = document.getElementById('questionInput').value.trim();
  if (!question) {
    alert('請輸入問題內容');
    return;
  }
  
  // 取得分鐘和秒數輸入
  const minutes = parseInt(document.getElementById('minutesInput').value) || 0;
  const seconds = parseInt(document.getElementById('secondsInput').value) || 0;
  timeLimit = minutes * 60 + seconds;
  
  if (timeLimit <= 0) {
    alert('請設定有效的時間');
    return;
  }
  
  const sessionRef = database.ref('class_rooms/' + currentRoom + '/session');
  const sessionSnapshot = await sessionRef.once('value');
  const currentSession = sessionSnapshot.val();
  
  if (currentSession.active) {
    // 暫停 - 確保完全清除計時器
    clearInterval(timer);
    timer = null;
    
    await sessionRef.update({
      active: false
    });
    
    sessionActive = false;
    // 隱藏主持人倒計時
    document.getElementById('hostCountdownContainer').classList.add('hidden');
  } else {
    // 開始新問題 - 先清除舊計時器
    clearInterval(timer);
    timer = null;
    
    // 生成新問題ID
    const newQuestionId = Date.now();
    currentQuestionId = newQuestionId;
    
    await database.ref('class_rooms/' + currentRoom).update({
      answers: {}, // 清空所有答案
      session: {
        active: true,
        question: question,
        questionId: newQuestionId, // 設定新問題ID
        timeLimit: timeLimit,
        startTime: firebase.database.ServerValue.TIMESTAMP,
        endTime: null
      }
    });
    
    // 重置所有學生的提交狀態
    const participantsRef = database.ref('class_rooms/' + currentRoom + '/participants');
    const participantsSnapshot = await participantsRef.once('value');
    const participants = participantsSnapshot.val() || {};
    
    for (const name in participants) {
      if (participants.hasOwnProperty(name)) {
        await participantsRef.child(name).update({
          submitted: false,
          late: false,
          lastQuestionId: newQuestionId // 更新最後回答的問題ID
        });
      }
    }
    
    sessionActive = true;
    remainingTime = timeLimit;
    
    // 立即更新顯示
    updateCountdownDisplay(remainingTime);
    // 顯示主持人倒計時
    document.getElementById('hostCountdownContainer').classList.remove('hidden');
  }
}

// 結束計時
async function endSession() {
if (!isHost || !currentRoom) return;
clearInterval(timer);
timer = null;
sessionActive = false;
await database.ref('class_rooms/' + currentRoom + '/session').update({
active: false,
endTime: firebase.database.ServerValue.TIMESTAMP
});
// 隱藏主持人倒計時
document.getElementById('hostCountdownContainer').classList.add('hidden');
}

// 清空本回合
async function clearSession() {
if (!isHost || !currentRoom) return;
clearInterval(timer);
timer = null;
sessionActive = false;
await database.ref('class_rooms/' + currentRoom).update({
session: {
active: false,
question: "",
questionId: Date.now(), // 新問題ID
timeLimit: 60,
startTime: null,
endTime: null
},
answers: {}
});

// 重置所有學生的提交狀態
const participantsRef = database.ref('class_rooms/' + currentRoom + '/participants');
const participantsSnapshot = await participantsRef.once('value');
const participants = participantsSnapshot.val() || {};
for (const name in participants) {
if (participants.hasOwnProperty(name)) {
await participantsRef.child(name).update({
submitted: false,
late: false,
lastQuestionId: null
});
}
}

// 重置UI
remainingTime = 60;
updateCountdownDisplay(remainingTime);
// 隱藏主持人倒計時
document.getElementById('hostCountdownContainer').classList.add('hidden');
document.getElementById('questionInput').value = '';
document.getElementById('minutesInput').value = '1';
document.getElementById('secondsInput').value = '0';
}

// 提交答案
async function submitAnswer() {
if (!currentRoom || !currentUser || isHost || hasSubmitted) return;
const answerText = document.getElementById('studentAnswer').value.trim();
if (!answerText) {
alert('請輸入答案');
return;
}

try {
// 檢查是否超時
const roomSnapshot = await database.ref('class_rooms/' + currentRoom).once('value');
const roomData = roomSnapshot.val();
let isLate = false;
if (roomData.session.active && roomData.session.startTime) {
const startTime = roomData.session.startTime;
const currentTime = Date.now();
const elapsed = Math.floor((currentTime - startTime) / 1000);
isLate = elapsed > roomData.session.timeLimit;
}

// 如果時間已到,不允許提交
if (remainingTime <= 0) {
alert('時間已到,無法提交答案');
return;
}

// 提交答案
const answerData = {
text: answerText,
timestamp: firebase.database.ServerValue.TIMESTAMP,
late: isLate
};
await database.ref('class_rooms/' + currentRoom + '/answers/' + currentUser).set(answerData);

// 更新參與者狀態
await database.ref('class_rooms/' + currentRoom + '/participants/' + currentUser).update({
submitted: true,
late: isLate,
lastQuestionId: roomData.session.questionId
});

// 顯示提交成功
hasSubmitted = true;
const submissionStatus = document.getElementById('submissionStatus');
const answerInputArea = document.getElementById('answerInputArea');
submissionStatus.classList.remove('hidden');
document.getElementById('studentAnswer').disabled = true;
document.getElementById('submitBtn').classList.add('hidden');
answerInputArea.classList.add('submitted');
if (isLate) {
answerInputArea.classList.add('late');
submissionStatus.innerHTML = '<i class="fas fa-clock text-red-500 mr-2"></i>已超時提交';
}
} catch (error) {
console.error('提交答案失敗:', error);
alert('提交答案失敗,請重試');
}
}

// 離開主持人介面
async function leaveHost() {
if (roomRef) {
roomRef.off();
roomRef = null;
}
if (currentRoom) {
// 移除房間
await database.ref('class_rooms/' + currentRoom).remove();
}
clearInterval(timer);
timer = null;
sessionActive = false;
// 隱藏主持人倒計時
document.getElementById('hostCountdownContainer').classList.add('hidden');
currentRoom = null;
currentUser = null;
isHost = false;
showMainMenu();
}

// 離開學生介面
async function leaveStudent() {
if (roomRef) {
roomRef.off();
roomRef = null;
}
if (currentRoom && currentUser) {
// 移除參與者
await database.ref('class_rooms/' + currentRoom + '/participants/' + currentUser).remove();
}
clearInterval(timer);
timer = null;
sessionActive = false;
currentRoom = null;
currentUser = null;
isHost = false;
hasSubmitted = false;
showMainMenu();
}

document.addEventListener('keydown', (e) => {
  // 如果正在編輯答案，不處理全域快捷鍵
  const activeElement = document.activeElement;
  if (activeElement && activeElement.classList.contains('answer-display') && activeElement.contentEditable === "true") {
    return;
  }
  
  // 其他全域快捷鍵處理...
});

    
// 頁面離開時清理
window.addEventListener('beforeunload', () => {
  // 新增：清理計時器
  clearInterval(timer);
  timer = null;
  
  if (currentRoom && currentUser) {
    if (isHost) {
      // 主持人離開時移除房間
      database.ref('class_rooms/' + currentRoom).remove();
    } else {
      // 學生離開時移除參與者
      database.ref('class_rooms/' + currentRoom + '/participants/' + currentUser).remove();
    }
  }
});

// 初始化頁面
document.addEventListener('DOMContentLoaded', () => {
  // 確保計時器為null
  timer = null;
  
  // 設置全屏回答功能
  setupFullscreenAnswers();
  
  // 自動調整學生答案文字框高度
  const studentAnswer = document.getElementById('studentAnswer');
  if (studentAnswer) {
    studentAnswer.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = this.scrollHeight + 'px';
    });
    studentAnswer.style.height = 'auto';
    studentAnswer.style.height = studentAnswer.scrollHeight + 'px';
  }
   
  // 檢查URL參數
  const urlParams = new URLSearchParams(window.location.search);
  const roomCode = urlParams.get('room');
  if (roomCode && roomCode.length === 6) {
    document.getElementById('joinRoomCode').value = roomCode;
    showJoinSection();
  } else {
    showMainMenu();
  }
});

// 為位置較上的全屏按鈕綁定事件
document.getElementById('fullscreenToggle').addEventListener('click', function() {
  if (!currentRoom) return;
  
  // 從 Firebase 獲取當前數據
  const roomRef = database.ref('class_rooms/' + currentRoom);
  roomRef.once('value').then(snapshot => {
    const roomData = snapshot.val();
    if (roomData && roomData.answers) {
      openFullscreenAnswers(roomData.answers, roomData.participants);
    }
  }).catch(error => {
    console.error('獲取全屏數據失敗:', error);
  });
});


    // 設置全屏回答功能
setupFullscreenAnswers();

// 為位置較上的全屏按鈕綁定事件
document.getElementById('fullscreenToggle').addEventListener('click', function() {
  if (!currentRoom) return;
  
  const roomRef = database.ref('class_rooms/' + currentRoom);
  roomRef.once('value').then(snapshot => {
    const roomData = snapshot.val();
    if (roomData && roomData.answers) {
      openFullscreenAnswers(roomData.answers, roomData.participants);
    }
  }).catch(error => {
    console.error('獲取全屏數據失敗:', error);
  });
});

    
    
</script>
<footer class="copyright-footer">
<p>Copyright © 2025 陳冠健. All rights reserved.</p>
</footer>





<!-- 全屏回答檢視 -->
<div id="fullscreenAnswers" class="fixed inset-0 bg-paper z-50 hidden flex flex-col">
  <!-- 頂部工具欄 -->
  <div class="bg-paper border-b border-stone-gray border-opacity-20 p-4 flex justify-between items-center shadow-sm">
    <h2 class="text-2xl font-bold text-charcoal">
      <i class="fas fa-comments text-clay-brown mr-3"></i>
      學生回答列表
    </h2>
    <div class="flex items-center gap-3">
      <!-- 字體控制按鈕 -->
      <div class="font-controls">
        <button class="font-btn decrease-font" title="縮小字體">
          <i class="fas fa-font"></i>
        </button>
        <button class="font-btn increase-font" title="放大字體">
          <i class="fas fa-font"></i><i class="fas fa-plus" style="font-size: 0.6em; margin-left: -2px;"></i>
        </button>
        <!-- 關閉按鈕移到這裡 -->
        <button id="closeFullscreen" class="fullscreen-toggle-btn" title="關閉全屏">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>
 
  <!-- 回答列表容器 -->
  <div id="fullscreenAnswersList" class="flex-1 overflow-y-auto p-6 bg-earth-beige">
    <!-- 回答將在這裡動態生成 -->
  </div>
</div>

    
</body>
</html>
